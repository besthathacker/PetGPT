<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PetGPT Ultimate</title>

<!-- PWA Manifest & Icon -->
<link rel="manifest" href="manifest.json" />
<link rel="icon" href="petgpt-icon-512.png" type="image/png" />
<meta name="theme-color" content="#121212" />

<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100vh; font-family: Arial, sans-serif;
    background: #121212; color: #eee; display: flex; overflow: hidden;
  }
  /* Sidebar */
  #sidebar {
    width: 280px; background: #1f1f1f; border-right: 2px solid #444;
    display: flex; flex-direction: column; padding: 10px;
  }
  #sidebar h2 {
    margin: 0 0 10px 0; text-align: center; color: #68a;
    user-select: none;
  }
  #chatList {
    flex-grow: 1; overflow-y: auto; border: 1px solid #333; background: #222;
    padding: 5px; border-radius: 6px;
  }
  #chatList div.chat-item {
    background: #2a2a2a; margin-bottom: 6px; padding: 8px 6px; border-radius: 4px;
    cursor: pointer; display: flex; align-items: center; justify-content: space-between;
    color: #ccc;
  }
  #chatList div.chat-item.active {
    background: #4466aa;
    color: white;
  }
  #chatList div.chat-item input {
    flex-grow: 1; background: transparent; border: none; color: white;
    font-size: 1rem; outline: none;
  }
  #chatControls {
    margin-top: 10px; display: flex; gap: 6px;
  }
  #chatControls button {
    flex-grow: 1; padding: 8px; border: none; background: #357; color: white;
    cursor: pointer; border-radius: 4px;
  }
  #chatControls button:disabled {
    background: #555; cursor: not-allowed;
  }
  /* Main area */
  #main {
    flex-grow: 1; display: flex; flex-direction: column; background: #1e1e1e;
  }
  #chatHeader {
    padding: 12px; background: #222; border-bottom: 1px solid #444;
    display: flex; justify-content: space-between; align-items: center;
  }
  #chatTitle {
    font-size: 1.3rem; color: #aaf;
    flex-grow: 1; user-select: none;
    outline: none;
  }
  #renameChatBtn, #deleteChatBtn {
    background: #4488cc; border: none; color: white; padding: 6px 12px;
    margin-left: 6px; border-radius: 4px; cursor: pointer;
  }
  #renameChatBtn:disabled, #deleteChatBtn:disabled {
    background: #555; cursor: not-allowed;
  }
  #chatArea {
    flex-grow: 1; overflow-y: auto; padding: 10px;
    display: flex; flex-direction: column; gap: 8px;
    background: #111;
  }
  .message {
    max-width: 70%; padding: 10px 14px; border-radius: 8px;
    word-wrap: break-word; white-space: pre-wrap;
  }
  .message.user {
    background: #2b4; align-self: flex-end; color: #010;
  }
  .message.bot {
    background: #3466bb; align-self: flex-start; color: white;
  }
  /* Input area */
  #inputArea {
    display: flex; padding: 10px; background: #222; border-top: 1px solid #444;
    gap: 6px; align-items: center;
  }
  #userInput {
    flex-grow: 1; padding: 8px 12px; border-radius: 6px; border: none;
    font-size: 1rem; background: #333; color: white;
  }
  #userInput::placeholder {
    color: #aaa;
  }
  button#sendBtn, button#voiceBtn, button#uploadBtn, button#imgGenBtn {
    background: #357; border: none; color: white;
    padding: 8px 12px; border-radius: 6px; cursor: pointer;
    user-select: none;
  }
  button:disabled {
    background: #555; cursor: not-allowed;
  }
  /* Hidden file input */
  #fileInput {
    display: none;
  }
  /* Personality selector */
  #personalitySelect {
    margin-left: 8px; background: #333; color: white; border: none; border-radius: 4px;
    padding: 6px;
    font-size: 1rem;
    user-select: none;
  }
  /* Filters */
  #filterArea {
    margin-top: 4px; padding: 6px 10px; background: #222; color: #ccc;
    font-size: 0.9rem; border-top: 1px solid #444;
  }
  /* Image modal */
  #imageModal {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    display: none; flex-direction: column; align-items: center; justify-content: center;
    z-index: 1000; padding: 10px;
  }
  #imageModal.visible {
    display: flex;
  }
  #imageModalContent {
    background: #222; padding: 12px; border-radius: 8px; max-width: 90vw; max-height: 80vh;
    display: flex; flex-direction: column; align-items: center;
  }
  #imagePreview {
    max-width: 100%; max-height: 60vh; border-radius: 6px; margin-bottom: 12px;
    background: black;
  }
  #imagePrompt {
    width: 100%; padding: 8px; border-radius: 6px; border: none; font-size: 1rem;
    margin-bottom: 8px; background: #333; color: white;
    resize: vertical;
  }
  #imageControls {
    display: flex; gap: 10px; width: 100%; justify-content: space-between;
    flex-wrap: wrap;
  }
  #imageControls > * {
    flex-grow: 1;
    min-width: 120px;
  }
  label {
    font-size: 0.85rem;
    display: flex; flex-direction: column; gap: 4px; color: #ccc;
  }
  input[type=range] {
    width: 100%;
  }
  #generateImageBtn, #closeImageModalBtn {
    padding: 8px 12px; border-radius: 6px; border: none;
    cursor: pointer; background: #357; color: white;
    user-select: none;
  }
  #closeImageModalBtn {
    background: #aa3333;
  }
  /* Virtual Pet */
  #petAvatar {
    position: fixed; bottom: 20px; right: 20px;
    width: 120px; height: 120px;
    background: url('petgpt-icon-512.png') no-repeat center/contain;
    border-radius: 50%; box-shadow: 0 0 10px #4466aaaa;
    cursor: pointer;
    transition: transform 0.3s ease;
    user-select: none;
  }
  #petAvatar:hover {
    transform: scale(1.1);
  }
</style>

<!-- Load Xenova GPT-2 -->
<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.4.0/dist/transformers.min.js"></script>
<!-- Load diffusers.js for Stable Diffusion -->
<script src="https://cdn.jsdelivr.net/npm/@xenova/diffusers@0.2.2/dist/diffusers.min.js"></script>

</head>
<body>

<div id="sidebar" role="navigation" aria-label="Chat list and controls">
  <h2>PetGPT Chats</h2>
  <div id="chatList" role="listbox" tabindex="0" aria-label="Chats list"></div>
  <div id="chatControls">
    <button id="newChatBtn" aria-label="Create new chat">+ New Chat</button>
    <button id="clearMemoryBtn" aria-label="Clear all chat memory">Clear Memory</button>
  </div>
  <div id="filterArea" aria-label="Chat filters and options">
    Filter: <input type="text" id="chatFilterInput" placeholder="Search chats or messages" aria-label="Chat search filter" />
    <select id="personalitySelect" aria-label="Personality selection">
      <option value="friendly">Friendly</option>
      <option value="roast">Roast (on request)</option>
      <option value="formal">Formal</option>
    </select>
  </div>
</div>

<div id="main" role="main">
  <div id="chatHeader" aria-live="polite">
    <div id="chatTitle" contenteditable="true" role="textbox" aria-label="Chat title" spellcheck="false">New Chat</div>
    <button id="renameChatBtn" aria-label="Rename chat">Rename</button>
    <button id="deleteChatBtn" aria-label="Delete chat">Delete</button>
  </div>

  <div id="chatArea" aria-live="polite" aria-relevant="additions" role="log"></div>

  <div id="inputArea">
    <input type="text" id="userInput" aria-label="Message input" placeholder="Type your message..." autocomplete="off" />
    <button id="sendBtn" aria-label="Send message">Send</button>
    <button id="voiceBtn" aria-label="Start voice input">üé§</button>
    <button id="uploadBtn" aria-label="Upload file">üìé</button>
    <button id="imgGenBtn" aria-label="Generate or edit image">üñºÔ∏è</button>
    <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.gif,.bmp,.pdf,.txt,.js,.py,.json,.html,.css,.cpp,.java,.c,.ts,.md" aria-hidden="true" />
  </div>
</div>

<!-- Image generation & editing modal -->
<div id="imageModal" role="dialog" aria-modal="true" aria-labelledby="imageModalTitle">
  <div id="imageModalContent">
    <h3 id="imageModalTitle" style="color:white;">Image Generation & Editing</h3>
    <img id="imagePreview" alt="Image preview" />
    <textarea id="imagePrompt" placeholder="Enter prompt or instructions here..." rows="3"></textarea>
    <div id="imageControls">
      <label>Width: <input type="range" id="imgWidth" min="256" max="768" step="64" value="512" /></label>
      <label>Height: <input type="range" id="imgHeight" min="256" max="768" step="64" value="512" /></label>
      <label>Steps: <input type="range" id="imgSteps" min="5" max="50" step="1" value="25" /></label>
      <label>Guidance Scale: <input type="range" id="imgGuidance" min="1" max="20" step="0.5" value="7.5" /></label>
    </div>
    <button id="generateImageBtn">Generate/Edit</button>
    <button id="closeImageModalBtn" style="margin-top:8px;">Close</button>
  </div>
</div>

<!-- Virtual Pet Avatar -->
<div id="petAvatar" title="Your virtual pet, Cheeto üê±"></div>

<script>
(async () => {
  // Load GPT-2 text-generation pipeline (only GPT-2 base)
  const pipeline = await window.Transformers.pipeline('text-generation', 'Xenova/gpt2');

  // Chat state and storage keys
  let chats = JSON.parse(localStorage.getItem('petgpt_chats') || '[]');
  let selectedChatId = localStorage.getItem('petgpt_selectedChat') || null;
  let personality = localStorage.getItem('petgpt_personality') || 'friendly';

  // UI elements
  const chatListEl = document.getElementById('chatList');
  const chatTitleEl = document.getElementById('chatTitle');
  const chatAreaEl = document.getElementById('chatArea');
  const userInputEl = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const voiceBtn = document.getElementById('voiceBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const fileInput = document.getElementById('fileInput');
  const newChatBtn = document.getElementById('newChatBtn');
  const clearMemoryBtn = document.getElementById('clearMemoryBtn');
  const renameChatBtn = document.getElementById('renameChatBtn');
  const deleteChatBtn = document.getElementById('deleteChatBtn');
  const chatFilterInput = document.getElementById('chatFilterInput');
  const personalitySelect = document.getElementById('personalitySelect');

  // Image modal elements
  const imageModal = document.getElementById('imageModal');
  const imagePreview = document.getElementById('imagePreview');
  const imagePrompt = document.getElementById('imagePrompt');
  const imgWidth = document.getElementById('imgWidth');
  const imgHeight = document.getElementById('imgHeight');
  const imgSteps = document.getElementById('imgSteps');
  const imgGuidance = document.getElementById('imgGuidance');
  const generateImageBtn = document.getElementById('generateImageBtn');
  const closeImageModalBtn = document.getElementById('closeImageModalBtn');

  // Virtual pet avatar element
  const petAvatar = document.getElementById('petAvatar');

  // Helpers
  function saveChats() {
    localStorage.setItem('petgpt_chats', JSON.stringify(chats));
  }
  function saveSelectedChat() {
    localStorage.setItem('petgpt_selectedChat', selectedChatId);
  }
  function savePersonality() {
    localStorage.setItem('petgpt_personality', personality);
  }

  // Create a new chat object
  function createNewChat(title = 'New Chat') {
    const newChat = {
      id: Date.now().toString(),
      title,
      messages: [],
    };
    chats.push(newChat);
    selectedChatId = newChat.id;
    saveChats();
    saveSelectedChat();
    return newChat;
  }

  // Delete chat by ID
  function deleteChat(id) {
    chats = chats.filter(c => c.id !== id);
    if (selectedChatId === id) {
      selectedChatId = chats.length ? chats[0].id : null;
    }
    saveChats();
    saveSelectedChat();
  }

  // Rename chat
  function renameChat(id, newTitle) {
    const chat = chats.find(c => c.id === id);
    if (chat) {
      chat.title = newTitle;
      saveChats();
    }
  }

  // Get selected chat object
  function getSelectedChat() {
    return chats.find(c => c.id === selectedChatId) || null;
  }

  // Render chat list in sidebar
  function renderChatList(filterText = '') {
    chatListEl.innerHTML = '';
    const lowerFilter = filterText.toLowerCase();
    chats.forEach(chat => {
      // Filter by chat title or messages content
      const matchTitle = chat.title.toLowerCase().includes(lowerFilter);
      const matchMessages = chat.messages.some(m => m.text.toLowerCase().includes(lowerFilter));
      if (!filterText || matchTitle || matchMessages) {
        const div = document.createElement('div');
        div.className = 'chat-item' + (chat.id === selectedChatId ? ' active' : '');
        div.dataset.id = chat.id;

        // Title input for rename inline editing
        const input = document.createElement('input');
        input.type = 'text';
        input.value = chat.title;
        input.title = "Rename chat";
        input.addEventListener('change', (e) => {
          renameChat(chat.id, e.target.value.trim() || 'Untitled');
          if (chat.id === selectedChatId) {
            chatTitleEl.textContent = e.target.value.trim() || 'Untitled';
          }
          renderChatList(filterText);
        });

        div.appendChild(input);

        div.addEventListener('click', (e) => {
          if (e.target !== input) {
            selectChat(chat.id);
          }
        });

        chatListEl.appendChild(div);
      }
    });
  }

  // Render messages in chat area
  function renderMessages() {
    chatAreaEl.innerHTML = '';
    const chat = getSelectedChat();
    if (!chat) return;
    chat.messages.forEach(msg => {
      const div = document.createElement('div');
      div.className = 'message ' + (msg.user ? 'user' : 'bot');
      div.textContent = msg.text;
      chatAreaEl.appendChild(div);
    });
    // Scroll bottom
    chatAreaEl.scrollTop = chatAreaEl.scrollHeight;
  }

  // Select chat
  function selectChat(id) {
    selectedChatId = id;
    saveSelectedChat();
    renderChatList(chatFilterInput.value);
    renderMessages();
    updateHeaderButtons();
    const chat = getSelectedChat();
    if (chat) chatTitleEl.textContent = chat.title;
  }

  // Update rename/delete buttons enabled state
  function updateHeaderButtons() {
    const hasChat = !!getSelectedChat();
    renameChatBtn.disabled = !hasChat;
    deleteChatBtn.disabled = !hasChat;
  }

  // Append message to chat and save
  function appendMessage(user, text) {
    const chat = getSelectedChat();
    if (!chat) return;
    chat.messages.push({ user, text });
    saveChats();
    renderMessages();
  }

  // Generate AI response
  async function generateResponse(prompt) {
    appendMessage(true, prompt);
    try {
      const personalityPrefix = {
        friendly: "You are a kind and helpful assistant.",
        roast: "You roast the user only when asked.",
        formal: "You respond in a formal and polite manner."
      }[personality] || "You are a helpful assistant.";
      const fullPrompt = `${personalityPrefix}\nUser: ${prompt}\nAssistant:`;
      const output = await pipeline(fullPrompt, { max_length: 200, do_sample: true });
      const responseText = output[0]?.generated_text?.slice(fullPrompt.length).trim() || "Sorry, I don't know what to say.";
      appendMessage(false, responseText);
    } catch (e) {
      appendMessage(false, "Error generating response: " + e.message);
    }
  }

  // Event handlers
  sendBtn.onclick = () => {
    const val = userInputEl.value.trim();
    if (!val) return;
    userInputEl.value = '';
    generateResponse(val);
  };
  userInputEl.onkeydown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  };

  newChatBtn.onclick = () => {
    const newChat = createNewChat();
    selectChat(newChat.id);
  };

  clearMemoryBtn.onclick = () => {
    if (confirm('Clear all chat memory? This cannot be undone.')) {
      chats = [];
      selectedChatId = null;
      saveChats();
      saveSelectedChat();
      renderChatList();
      renderMessages();
      updateHeaderButtons();
      chatTitleEl.textContent = 'New Chat';
    }
  };

  renameChatBtn.onclick = () => {
    const chat = getSelectedChat();
    if (!chat) return;
    const newName = prompt('Enter new chat name:', chat.title);
    if (newName && newName.trim()) {
      renameChat(chat.id, newName.trim());
      chatTitleEl.textContent = newName.trim();
      renderChatList(chatFilterInput.value);
    }
  };

  deleteChatBtn.onclick = () => {
    const chat = getSelectedChat();
    if (!chat) return;
    if (confirm(`Delete chat "${chat.title}"? This cannot be undone.`)) {
      deleteChat(chat.id);
      renderChatList(chatFilterInput.value);
      renderMessages();
      updateHeaderButtons();
      if (selectedChatId) {
        const newChat = getSelectedChat();
        if (newChat) chatTitleEl.textContent = newChat.title;
      } else {
        chatTitleEl.textContent = 'New Chat';
      }
    }
  };

  chatFilterInput.oninput = () => {
    renderChatList(chatFilterInput.value);
  };

  personalitySelect.value = personality;
  personalitySelect.onchange = () => {
    personality = personalitySelect.value;
    savePersonality();
  };

  // Select a chat or create default if none exist
  if (!chats.length) {
    const newChat = createNewChat();
    selectedChatId = newChat.id;
  }
  saveChats();
  saveSelectedChat();
  renderChatList();
  selectChat(selectedChatId);
  updateHeaderButtons();

  // File upload handling
  uploadBtn.onclick = () => fileInput.click();
  fileInput.onchange = async () => {
    if (!fileInput.files.length) return;
    const file = fileInput.files[0];
    const ext = file.name.split('.').pop().toLowerCase();
    const chat = getSelectedChat();
    if (!chat) return;

    if (['png', 'jpg', 'jpeg', 'gif', 'bmp'].includes(ext)) {
      // Show image preview in chat
      const reader = new FileReader();
      reader.onload = () => {
        appendMessage(true, `[Image uploaded: ${file.name}]`);
        appendMessage(false, "Nice image! (Pretend AI response here.)");
      };
      reader.readAsDataURL(file);
    } else if (ext === 'pdf') {
      appendMessage(true, `[PDF uploaded: ${file.name}]`);
      appendMessage(false, "Sorry, PDF reading not yet supported.");
    } else {
      // Assume text file/code
      const text = await file.text();
      appendMessage(true, `[File uploaded: ${file.name}]\n` + text.slice(0, 500) + (text.length > 500 ? '...' : ''));
      appendMessage(false, "I received your file content!");
    }
    fileInput.value = '';
  };

  // Image generation & editing modal logic
  let stableDiffusionModel = null;
  async function loadStableDiffusion() {
    if (!stableDiffusionModel) {
      try {
        stableDiffusionModel = await window.DiffusersStableDiffusion.from_pretrained('stabilityai/stable-diffusion-2-base', { cacheDir: '/sd_cache' });
      } catch(e) {
        alert('Failed to load Stable Diffusion model: ' + e.message);
      }
    }
  }

  document.getElementById('imgGenBtn').onclick = async () => {
    await loadStableDiffusion();
    imageModal.classList.add('visible');
    imagePreview.src = '';
    imagePrompt.value = '';
  };

  closeImageModalBtn.onclick = () => {
    imageModal.classList.remove('visible');
  };

  generateImageBtn.onclick = async () => {
    if (!stableDiffusionModel) {
      alert('Stable Diffusion model not loaded.');
      return;
    }
    const prompt = imagePrompt.value.trim();
    if (!prompt) {
      alert('Please enter a prompt.');
      return;
    }
    const width = parseInt(imgWidth.value);
    const height = parseInt(imgHeight.value);
    const steps = parseInt(imgSteps.value);
    const guidance = parseFloat(imgGuidance.value);

    generateImageBtn.disabled = true;
    generateImageBtn.textContent = 'Generating...';

    try {
      const result = await stableDiffusionModel.generate(prompt, {
        width,
        height,
        num_inference_steps: steps,
        guidance_scale: guidance,
      });
      imagePreview.src = result.images[0];
    } catch(e) {
      alert('Image generation failed: ' + e.message);
    } finally {
      generateImageBtn.disabled = false;
      generateImageBtn.textContent = 'Generate/Edit';
    }
  };

  // Virtual pet avatar click interaction
  petAvatar.onclick = () => {
    alert("Meow! I'm your virtual pet Cheeto üê±. Let's chat!");
  };

  // Voice input button (placeholder)
  voiceBtn.onclick = () => {
    alert('Voice input not implemented yet.');
  };

})();
</script>

</body>
</html>
