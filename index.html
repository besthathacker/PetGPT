<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PetGPT + GPT-2 (Safari-friendly)</title>
<style>
  body { font-family:Arial,sans-serif; background:#1e1e1e; color:white; margin:0; padding:0; display:flex; flex-direction:column; height:100vh; }
  header { background:#007acc; padding:16px; text-align:center; font-size:20px; }
  #chat { flex:1; overflow-y:auto; padding:10px; background:#2b2b2b; }
  .message { margin:6px 0; padding:8px; border-radius:6px; max-width:75%; word-wrap:break-word; }
  .user { background:#3a3a3a; align-self:flex-end; }
  .bot  { background:#007acc; align-self:flex-start; }
  #controls { display:flex; padding:10px; background:#111; border-top:1px solid #444; }
  #userInput { flex:1; padding:8px; border:none; border-radius:4px; background:#333; color:#eee; }
  button { margin-left:6px; padding:8px 12px; border:none; border-radius:4px; background:#007acc; color:#fff; cursor:pointer; }
  #adminPanel { display:none; background:#333; padding:10px; border-top:2px solid #007acc; }
  #adminPanel h4,#adminPanel label { margin:6px 0; }
</style>
</head>
<body>
  <header>🐾 PetGPT + GPT-2 (Safari-friendly)</header>
  <div id="chat"></div>
  <div id="controls">
    <input id="userInput" placeholder="Type your message…" autocomplete="off" />
    <button id="sendBtn">Send</button>
    <button id="resetBtn">Reset Memory</button>
    <button id="voiceBtn">🎤 Voice Chat</button>
  </div>
  <div id="adminPanel">
    <h4>Admin Panel (type “cheeto”)</h4>
    <label>Background Color: <input type="color" id="bgPicker" value="#1e1e1e" /></label>
  </div>

  <!-- transformers.js -->
  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.5.0/dist/transformers.min.js"></script>
  <script>
  (async () => {
    // Force single-threaded WASM for Safari
    window.transformers.env.wasm.numThreads = 1;
    window.transformers.env.wasm.simd = false;
    window.transformers.env.wasm.supportsThreads = false;

    const chat = document.getElementById('chat');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const resetBtn = document.getElementById('resetBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const adminPanel = document.getElementById('adminPanel');
    const bgPicker = document.getElementById('bgPicker');

    let memory = JSON.parse(localStorage.getItem('petgpt-memory')||'{}');

    // Fallback keyword replies
    const fallbackModel = { hello:"Hi there!", bye:"Goodbye!" };
    for(let i=0;i<300;i++) fallbackModel["keyword"+i] = "This is reply "+i+".";

    let tokenizer, model, gptReady=false;

    function append(msg,cls){
      const d=document.createElement('div');
      d.className='message '+cls;
      d.textContent=msg;
      chat.appendChild(d);
      chat.scrollTop=chat.scrollHeight;
    }
    function saveMem(){ localStorage.setItem('petgpt-memory', JSON.stringify(memory)); }

    async function getReply(text){
      const t=text.toLowerCase();
      if(t.startsWith('remember:')){
        const [k,v]=t.slice(9).split('=').map(s=>s.trim());
        if(k&&v){ memory[k]=v; saveMem(); return `Remembered ${k}=${v}`; }
        return 'Use: remember:key=value';
      }
      for(let k in memory) if(t.includes(k.toLowerCase())) return `You told me ${k}=${memory[k]}`;
      if(t.includes('cheeto')){ adminPanel.style.display='block'; return 'Admin unlocked!'; }

      if(gptReady){
        try{
          const enc = await tokenizer.encode(text);
          const out = await model.generate(enc.inputIds, {
            max_new_tokens:50, do_sample:true, temperature:0.7, top_p:0.9
          });
          let reply = await tokenizer.decode(out[0]);
          if(reply.toLowerCase().startsWith(text.toLowerCase())){
            reply = reply.slice(text.length).trim();
          }
          return reply||"I have nothing to say.";
        }catch(e){
          console.error(e);
        }
      }
      // fallback
      for(let k in fallbackModel){
        if(text.toLowerCase().includes(k)) return fallbackModel[k];
      }
      return "Sorry, I don't understand.";
    }

    async function sendMessage(){
      const txt=userInput.value.trim();
      if(!txt) return;
      append('You: '+txt,'user');
      userInput.value=''; userInput.disabled=true; sendBtn.disabled=true;
      try{
        const r=await getReply(txt);
        append('PetGPT: '+r,'bot');
      }catch(e){
        append('PetGPT: Error occurred','bot');
      }finally{
        userInput.disabled=false; sendBtn.disabled=false; userInput.focus();
      }
    }
    sendBtn.onclick=sendMessage;
    userInput.addEventListener('keydown',e=>{
      if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }
    });

    resetBtn.onclick=()=>{
      if(confirm("Clear memory and chat?")){
        localStorage.clear(); memory={}; chat.innerHTML='';
        append("Memory cleared.","bot");
      }
    };
    bgPicker.oninput=e=>document.body.style.background=e.target.value;

    // Voice chat setup
    let recognition, listening=false;
    if(window.SpeechRecognition||window.webkitSpeechRecognition){
      const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
      recognition=new SR();
      recognition.lang='en-US';
      recognition.onstart=()=>{ listening=true; voiceBtn.textContent='🛑 Stop'; };
      recognition.onend=()=>{ listening=false; voiceBtn.textContent='🎤 Voice Chat'; };
      recognition.onresult=e=>{
        userInput.value=e.results[0][0].transcript.trim();
        sendMessage();
      };
    }
    voiceBtn.onclick=()=>{
      if(!recognition) return alert('No SpeechRecognition');
      listening?recognition.stop():recognition.start();
    };

    append("Loading GPT-2 model… please wait","bot");
    try{
      tokenizer = await window.transformers.AutoTokenizer.fromPretrained("gpt2", {
        progressCallback:p=>console.log("Tok",p)
      });
      model = await window.transformers.AutoModelForCausalLM.fromPretrained("gpt2", {
        progressCallback:p=>console.log("Mod",p)
      });
      gptReady=true;
      append("GPT-2 loaded! Test worked.","bot");
    }catch(e){
      console.error("Load error:",e);
      append("GPT-2 failed—using fallback.","bot");
    }
    userInput.focus();
  })();
  </script>
</body>
</html>
