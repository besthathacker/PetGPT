<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PetGPT + GPT-2 (Safari-friendly)</title>
<style>
Â Â body { font-family:Arial,sans-serif; background:#1e1e1e; color:white; margin:0; padding:0; display:flex; flex-direction:column; height:100vh; }
Â Â header { background:#007acc; padding:16px; text-align:center; font-size:20px; }
Â Â #chat { flex:1; overflow-y:auto; padding:10px; background:#2b2b2b; }
Â Â .message { margin:6px 0; padding:8px; border-radius:6px; max-width:75%; word-wrap:break-word; }
Â Â .user { background:#3a3a3a; align-self:flex-end; }
Â Â .botÂ Â { background:#007acc; align-self:flex-start; }
Â Â #controls { display:flex; padding:10px; background:#111; border-top:1px solid #444; }
Â Â #userInput { flex:1; padding:8px; border:none; border-radius:4px; background:#333; color:#eee; }
Â Â button { margin-left:6px; padding:8px 12px; border:none; border-radius:4px; background:#007acc; color:#fff; cursor:pointer; }
Â Â #adminPanel { display:none; background:#333; padding:10px; border-top:2px solid #007acc; }
Â Â #adminPanel h4,#adminPanel label { margin:6px 0; }
</style>
</head>
<body>
Â Â <header>ğŸ¾ PetGPT + GPT-2 (Safari-friendly)</header>
Â Â <div id="chat"></div>
Â Â <div id="controls">
Â Â Â Â <input id="userInput" placeholder="Type your messageâ€¦" autocomplete="off" />
Â Â Â Â <button id="sendBtn">Send</button>
Â Â Â Â <button id="resetBtn">Reset Memory</button>
Â Â Â Â <button id="voiceBtn">ğŸ¤ Voice Chat</button>
Â Â </div>
Â Â <div id="adminPanel">
Â Â Â Â <h4>Admin Panel (type â€œcheetoâ€)</h4>
Â Â Â Â <label>Background Color: <input type="color" id="bgPicker" value="#1e1e1e" /></label>
Â Â </div>

Â Â <!-- transformers.js -->
Â Â <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.5.0/dist/transformers.min.js"></script>
Â Â <script>
Â Â (async () => {
Â Â Â Â // Force single-threaded WASM for Safari
Â Â Â Â window.transformers.env.wasm.numThreads = 1;
Â Â Â Â window.transformers.env.wasm.simd = false;
Â Â Â Â window.transformers.env.wasm.supportsThreads = false;

Â Â Â Â const chat = document.getElementById('chat');
Â Â Â Â const userInput = document.getElementById('userInput');
Â Â Â Â const sendBtn = document.getElementById('sendBtn');
Â Â Â Â const resetBtn = document.getElementById('resetBtn');
Â Â Â Â const voiceBtn = document.getElementById('voiceBtn');
Â Â Â Â const adminPanel = document.getElementById('adminPanel');
Â Â Â Â const bgPicker = document.getElementById('bgPicker');

Â Â Â Â let memory = JSON.parse(localStorage.getItem('petgpt-memory')||'{}');

Â Â Â Â // Fallback keyword replies
Â Â Â Â const fallbackModel = { hello:"Hi there!", bye:"Goodbye!" };
Â Â Â Â for(let i=0;i<300;i++) fallbackModel["keyword"+i] = "This is reply "+i+".";

Â Â Â Â let tokenizer, model, gptReady=false;

Â Â Â Â function append(msg,cls){
Â Â Â Â Â Â const d=document.createElement('div');
Â Â Â Â Â Â d.className='message '+cls;
Â Â Â Â Â Â d.textContent=msg;
Â Â Â Â Â Â chat.appendChild(d);
Â Â Â Â Â Â chat.scrollTop=chat.scrollHeight;
Â Â Â Â }
Â Â Â Â function saveMem(){ localStorage.setItem('petgpt-memory', JSON.stringify(memory)); }

Â Â Â Â async function getReply(text){
Â Â Â Â Â Â const t=text.toLowerCase();
Â Â Â Â Â Â if(t.startsWith('remember:')){
Â Â Â Â Â Â Â Â const [k,v]=t.slice(9).split('=').map(s=>s.trim());
Â Â Â Â Â Â Â Â if(k&&v){ memory[k]=v; saveMem(); return `Remembered ${k}=${v}`; }
Â Â Â Â Â Â Â Â return 'Use: remember:key=value';
Â Â Â Â Â Â }
Â Â Â Â Â Â for(let k in memory) if(t.includes(k.toLowerCase())) return `You told me ${k}=${memory[k]}`;
Â Â Â Â Â Â if(t.includes('cheeto')){ adminPanel.style.display='block'; return 'Admin unlocked!'; }

Â Â Â Â Â Â if(gptReady){
Â Â Â Â Â Â Â Â try{
Â Â Â Â Â Â Â Â Â Â const enc = await tokenizer.encode(text);
Â Â Â Â Â Â Â Â Â Â const out = await model.generate(enc.inputIds, {
Â Â Â Â Â Â Â Â Â Â Â Â max_new_tokens:50, do_sample:true, temperature:0.7, top_p:0.9
Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â let reply = await tokenizer.decode(out[0]);
Â Â Â Â Â Â Â Â Â Â if(reply.toLowerCase().startsWith(text.toLowerCase())){
Â Â Â Â Â Â Â Â Â Â Â Â reply = reply.slice(text.length).trim();
Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â return reply||"I have nothing to say.";
Â Â Â Â Â Â Â Â }catch(e){
Â Â Â Â Â Â Â Â Â Â console.error(e);
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â }
Â Â Â Â Â Â // fallback
Â Â Â Â Â Â for(let k in fallbackModel){
Â Â Â Â Â Â Â Â if(text.toLowerCase().includes(k)) return fallbackModel[k];
Â Â Â Â Â Â }
Â Â Â Â Â Â return "Sorry, I don't understand.";
Â Â Â Â }

Â Â Â Â async function sendMessage(){
Â Â Â Â Â Â const txt=userInput.value.trim();
Â Â Â Â Â Â if(!txt) return;
Â Â Â Â Â Â append('You: '+txt,'user');
Â Â Â Â Â Â userInput.value=''; userInput.disabled=true; sendBtn.disabled=true;
Â Â Â Â Â Â try{
Â Â Â Â Â Â Â Â const r=await getReply(txt);
Â Â Â Â Â Â Â Â append('PetGPT: '+r,'bot');
Â Â Â Â Â Â }catch(e){
Â Â Â Â Â Â Â Â append('PetGPT: Error occurred','bot');
Â Â Â Â Â Â }finally{
Â Â Â Â Â Â Â Â userInput.disabled=false; sendBtn.disabled=false; userInput.focus();
Â Â Â Â Â Â }
Â Â Â Â }
Â Â Â Â sendBtn.onclick=sendMessage;
Â Â Â Â userInput.addEventListener('keydown',e=>{
Â Â Â Â Â Â if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }
Â Â Â Â });

Â Â Â Â resetBtn.onclick=()=>{
Â Â Â Â Â Â if(confirm("Clear memory and chat?")){
Â Â Â Â Â Â Â Â localStorage.clear(); memory={}; chat.innerHTML='';
Â Â Â Â Â Â Â Â append("Memory cleared.","bot");
Â Â Â Â Â Â }
Â Â Â Â };
Â Â Â Â bgPicker.oninput=e=>document.body.style.background=e.target.value;

Â Â Â Â // Voice chat setup
Â Â Â Â let recognition, listening=false;
Â Â Â Â if(window.SpeechRecognition||window.webkitSpeechRecognition){
Â Â Â Â Â Â const SR = window.SpeechRecognition||window.webkitSpeechRecognition;
Â Â Â Â Â Â recognition=new SR();
Â Â Â Â Â Â recognition.lang='en-US';
Â Â Â Â Â Â recognition.onstart=()=>{ listening=true; voiceBtn.textContent='ğŸ›‘ Stop'; };
Â Â Â Â Â Â recognition.onend=()=>{ listening=false; voiceBtn.textContent='ğŸ¤ Voice Chat'; };
Â Â Â Â Â Â recognition.onresult=e=>{
Â Â Â Â Â Â Â Â userInput.value=e.results[0][0].transcript.trim();
Â Â Â Â Â Â Â Â sendMessage();
Â Â Â Â Â Â };
Â Â Â Â }
Â Â Â Â voiceBtn.onclick=()=>{
Â Â Â Â Â Â if(!recognition) return alert('No SpeechRecognition');
Â Â Â Â Â Â listening?recognition.stop():recognition.start();
Â Â Â Â };

Â Â Â Â append("Loading GPT-2 modelâ€¦ please wait","bot");
Â Â Â Â try{
Â Â Â Â Â Â tokenizer = await window.transformers.AutoTokenizer.fromPretrained("gpt2", {
Â Â Â Â Â Â Â Â progressCallback:p=>console.log("Tok",p)
Â Â Â Â Â Â });
Â Â Â Â Â Â model = await window.transformers.AutoModelForCausalLM.fromPretrained("gpt2", {
Â Â Â Â Â Â Â Â progressCallback:p=>console.log("Mod",p)
Â Â Â Â Â Â });
Â Â Â Â Â Â gptReady=true;
Â Â Â Â Â Â append("GPT-2 loaded! Test worked.","bot");
Â Â Â Â }catch(e){
Â Â Â Â Â Â console.error("Load error:",e);
Â Â Â Â Â Â append("GPT-2 failedâ€”using fallback.","bot");
Â Â Â Â }
Â Â Â Â userInput.focus();
Â Â })();
Â Â </script>
</body>
</html>
