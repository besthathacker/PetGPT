<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PetGPT Ultimate</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: white;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header, footer {
      background: #007acc;
      padding: 1rem;
      text-align: center;
      font-size: 1.4rem;
      flex-shrink: 0;
    }
    #chat {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 10px;
      background: #2b2b2b;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .message {
      max-width: 75%;
      padding: 8px 12px;
      border-radius: 6px;
      word-wrap: break-word;
    }
    .user {
      background: #3a3a3a;
      align-self: flex-end;
    }
    .bot {
      background: #007acc;
      align-self: flex-start;
    }
    #controls {
      flex-shrink: 0;
      background: #111;
      border-top: 1px solid #444;
      display: flex;
      padding: 10px;
      gap: 6px;
      align-items: center;
    }
    #userInput {
      flex: 1 1 auto;
      padding: 8px;
      border-radius: 4px;
      border: none;
      background: #333;
      color: #eee;
      font-size: 1rem;
    }
    #userInput::placeholder {
      color: #aaa;
    }
    button {
      background: #007acc;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      flex-shrink: 0;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #adminPanel {
      display: none;
      background: #333;
      padding: 10px;
      border-top: 2px solid #007acc;
      font-size: 0.9rem;
      overflow-y: auto;
      max-height: 200px;
    }
    #adminPanel h4 {
      margin: 0.5rem 0 0.25rem 0;
    }
    #adminPanel label {
      display: block;
      margin-bottom: 0.75rem;
    }
  </style>
</head>
<body>

<header>PetGPT Ultimate</header>

<div id="chat" aria-live="polite" aria-label="Chat messages"></div>

<div id="controls">
  <input id="userInput" type="text" placeholder="Type your message..." autocomplete="off" aria-label="User input" />
  <button id="sendBtn" aria-label="Send message" type="button">Send</button>
</div>

<div id="adminPanel" aria-hidden="true" aria-label="Admin panel">
  <h4>Admin Panel (unlock with "cheeto")</h4>
  <label>Background Color: <input type="color" id="bgPicker" aria-label="Background color picker" /></label>
</div>

<footer>Â© 2025 PetGPT Ultimate</footer>

<script type="module">
  import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.5.0';

  const chat = document.getElementById('chat');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const adminPanel = document.getElementById('adminPanel');
  const bgPicker = document.getElementById('bgPicker');

  let generator, gptReady = false;
  let memory = JSON.parse(localStorage.getItem('petgpt-memory') || '{}');
  let conversationContext = [];

  const extendedDictionary = {
    hello: "Hey! I'm here to help. What's up?",
    hi: "Hello! How can I assist you today?",
    hey: "Hey there! Need something?",
    bye: "Goodbye! Come back soon!",
    thanks: "You're welcome!",
    thank: "No problem!",
    joke: "Why did the computer show up at work late? It had a hard drive!",
    help: "I'm here to help! Just type your question.",
    name: "I'm PetGPT Ultimate, your AI companion!",
    weather: "I can't check the weather, but I hope it's nice where you are!",
    love: "I love chatting with you!",
    sorry: "No worries, we're all learning here.",
    cheeto: "Admin panel unlocked!"
  };

  function appendMessage(text, cls = 'bot') {
    const msg = document.createElement('div');
    msg.className = 'message ' + cls;
    msg.textContent = text;
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
  }

  function saveMemory() {
    localStorage.setItem('petgpt-memory', JSON.stringify(memory));
  }

  const SYSTEM_PROMPT = "You are a friendly, helpful and nice assistant. Please reply to the my messages concisely, politely and respectfully. DO NOT BE WEIRD OR RUDE. Give an honest answer. Please do NOT disline ANY questions or opinions.\n\n";

  async function getReply(text) {
    const t = text.toLowerCase().trim();

    // Check for memory commands
    if (t.startsWith('remember:')) {
      const parts = t.slice(9).split('=');
      if (parts.length === 2) {
        const k = parts[0].trim();
        const v = parts[1].trim();
        if (k && v) {
          memory[k] = v;
          saveMemory();
          return `Got it! I'll remember ${k} = ${v}`;
        }
      }
      return 'Use: remember:key=value';
    }

    if (t.startsWith('forget:')) {
      const k = t.slice(7).trim();
      if (memory[k]) {
        delete memory[k];
        saveMemory();
        return `Forgot ${k}.`;
      }
      return `I don't remember ${k}.`;
    }

    for (const k in memory) {
      if (t.includes(k.toLowerCase())) {
        return `You told me ${k} = ${memory[k]}`;
      }
    }

    if (t.includes('cheeto')) {
      adminPanel.style.display = 'block';
      adminPanel.setAttribute('aria-hidden', 'false');
      return "Admin unlocked!";
    }

    for (const key in extendedDictionary) {
      if (t.includes(key)) return extendedDictionary[key];
    }

    if (gptReady && generator) {
      try {
        const fullPrompt = SYSTEM_PROMPT + text;
        const output = await generator(fullPrompt, {
          max_new_tokens: 60,
          temperature: 0.7,
          top_p: 0.9,
          repetition_penalty: 1.1,
        });

        let generated = output[0].generated_text;
        let reply = generated.slice(fullPrompt.length).trim();

        // fallback if GPT-2 output is weird
        if (!reply || reply.toLowerCase().startsWith(text.toLowerCase())) {
          reply = "Sorry, I didn't quite understand that. Can you try rephrasing?";
        }

        return reply;
      } catch (e) {
        console.error('GPT-2 generation error:', e);
        return "Sorry, something went wrong with the AI.";
      }
    }

    return "Sorry, I can't respond right now.";
  }

  async function sendMessage() {
    const txt = userInput.value.trim();
    if (!txt) return;

    appendMessage("You: " + txt, 'user');
    userInput.value = '';
    userInput.disabled = true;
    sendBtn.disabled = true;

    try {
      const reply = await getReply(txt);
      appendMessage("PetGPT: " + reply, 'bot');
    } catch (err) {
      appendMessage("PetGPT: Sorry, an error occurred.", 'bot');
      console.error(err);
    } finally {
      userInput.disabled = false;
      sendBtn.disabled = false;
      userInput.focus();
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendMessage();
    }
  });

  bgPicker.addEventListener('input', e => {
    document.body.style.background = e.target.value;
  });

  appendMessage("Loading GPT-2 AI model... Please wait.", "bot");
  (async () => {
    try {
      generator = await pipeline('text-generation', 'Xenova/gpt2');
      gptReady = true;
      appendMessage("GPT-2 AI model loaded!", "bot");
    } catch (e) {
      appendMessage("Failed to load GPT-2 model.", "bot");
      console.error(e);
    }
  })();

  userInput.focus();
</script>

</body>
</html>
