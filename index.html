<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PetGPT Ultimate</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.5.0/dist/transformers.min.js"></script>
  <style>
    body {
      margin: 0; padding: 0;
      background: #1e1e1e;
      color: #eee;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header, footer {
      background: #007acc;
      color: white;
      text-align: center;
      padding: 1rem;
      flex-shrink: 0;
    }
    #container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 800px;
      margin: auto;
      width: 100%;
      padding: 1rem;
      box-sizing: border-box;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 1rem;
      padding-right: 0.5rem;
    }
    .message {
      margin: 0.5rem 0;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      background: #333;
      max-width: 80%;
      word-wrap: break-word;
    }
    .user { align-self: flex-end; background: #444; }
    .bot  { align-self: flex-start; }
    #controls {
      display: flex;
      gap: 0.5rem;
    }
    input[type="text"] {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 8px;
      background: #222;
      color: white;
    }
    button {
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 8px;
      background: #007acc;
      color: white;
      cursor: pointer;
    }
    button:disabled { opacity: 0.5; cursor: default; }
    #adminPanel {
      display: none;
      margin-top: 1rem;
      padding: 1rem;
      background: #333;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <header>🐾 PetGPT Ultimate</header>
  <div id="container">
    <div id="chat"></div>
    <div id="controls">
      <input type="text" id="userInput" placeholder="Say something…" autocomplete="off" />
      <button id="sendBtn">Send</button>
      <button id="resetBtn">Reset Memory</button>
      <button id="voiceBtn">🎤 Voice Chat</button>
    </div>
    <div id="adminPanel">
      <h4>Admin Panel (type “cheeto” to unlock)</h4>
      <label>
        Background Color:
        <input type="color" id="bgPicker" />
      </label>
    </div>
  </div>
  <footer>© 2025 PetGPT Ultimate</footer>

  <script>
    const container = document.getElementById('container');
    const chat = document.getElementById('chat');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const resetBtn = document.getElementById('resetBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const adminPanel = document.getElementById('adminPanel');
    const bgPicker = document.getElementById('bgPicker');

    let tokenizer, model, gptReady = false;
    let memory = JSON.parse(localStorage.getItem('petgpt-memory') || '{}');

    function append(msg, cls = 'bot') {
      const el = document.createElement('div');
      el.className = `message ${cls}`;
      el.textContent = msg;
      chat.appendChild(el);
      chat.scrollTop = chat.scrollHeight;
    }

    async function initAI() {
      append('Loading GPT‑2 AI… please wait.', 'bot');
      try {
        tokenizer = await transformers.AutoTokenizer.from_pretrained('gpt2');
        model     = await transformers.AutoModelForCausalLM.from_pretrained('gpt2');
        gptReady = true;
        append('✅ GPT‑2 loaded! Ask me anything.', 'bot');
      } catch (e) {
        console.error(e);
        append('⚠️ GPT‑2 failed to load. Using fallback responses.', 'bot');
      }
    }

    async function getReply(text) {
      const t = text.trim().toLowerCase();

      if (t.startsWith('remember:')) {
        const [k, v] = t.slice(9).split('=').map(s => s.trim());
        if (k && v) {
          memory[k] = v;
          localStorage.setItem('petgpt-memory', JSON.stringify(memory));
          return `Got it! I’ll remember ${k} = ${v}`;
        }
        return '❓ Format: remember:key=value';
      }

      for (const k in memory) {
        if (t.includes(k.toLowerCase())) {
          return `🔖 You told me ${k} = ${memory[k]}`;
        }
      }

      if (t.includes('cheeto')) {
        adminPanel.style.display = 'block';
        return '🎉 Admin unlocked!';
      }

      if (gptReady && model && tokenizer) {
        try {
          const enc = await tokenizer.encode(text);
          const out = await model.generate(enc.inputIds, {
            max_new_tokens: 50,
            do_sample: true,
            temperature: 0.7,
            top_p: 0.9,
          });
          let resp = await tokenizer.decode(out[0], { skip_special_tokens: true });
          resp = resp.replace(text, '').trim() || 'Hmm... not sure what to say.';
          return resp;
        } catch (e) {
          console.error('AI error:', e);
        }
      }

      const fallback = {
        hello: "Hi there! How can I help?",
        bye: "Goodbye! See you soon.",
      };
      for (const k in fallback) {
        if (t.includes(k)) return fallback[k];
      }

      return "Sorry, I don't understand.";
    }

    async function sendMessage() {
      const txt = userInput.value.trim();
      if (!txt) return;

      append(`You: ${txt}`, 'user');
      userInput.value = '';
      sendBtn.disabled = true;
      userInput.disabled = true;

      const reply = await getReply(txt);
      append(reply, 'bot');

      sendBtn.disabled = false;
      userInput.disabled = false;
      userInput.focus();
    }

    sendBtn.onclick = sendMessage;
    userInput.onkeydown = e => {
      if (e.key === 'Enter') {
        sendMessage();
        e.preventDefault();
      }
    };

    resetBtn.onclick = () => {
      if (confirm('Clear memory and chat?')) {
        localStorage.clear();
        memory = {};
        chat.innerHTML = '';
        append('Memory cleared.', 'bot');
      }
    };

    bgPicker.oninput = e => document.body.style.background = e.target.value;

    // Voice input
    let rec, recognizing = false;
    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      rec = new SR();
      rec.lang = 'en-US';
      rec.interimResults = false;
      rec.onstart = () => { recognizing = true; voiceBtn.textContent = '🛑 Stop'; };
      rec.onend = () => { recognizing = false; voiceBtn.textContent = '🎤 Voice Chat'; };
      rec.onerror = () => { recognizing = false; voiceBtn.textContent = '🎤 Voice Chat'; };
      rec.onresult = e => {
        userInput.value = e.results[0][0].transcript;
        sendMessage();
      };
      voiceBtn.onclick = () => recognizing ? rec.stop() : rec.start();
    } else {
      voiceBtn.onclick = () => alert('Speech recognition not supported.');
    }

    userInput.focus();
    initAI();
  </script>
</body>
</html>
