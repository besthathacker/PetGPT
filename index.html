<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PetGPT - GPT-2 Web Chat</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #1e1e1e;
      color: white;
      font-family: Arial, sans-serif;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #007acc;
      padding: 16px;
      text-align: center;
      font-size: 22px;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      background: #2b2b2b;
    }
    .message {
      margin: 6px 0;
      padding: 8px 12px;
      border-radius: 6px;
      max-width: 75%;
      word-wrap: break-word;
    }
    .user { background: #3a3a3a; align-self: flex-end; }
    .bot  { background: #007acc; align-self: flex-start; }
    #controls {
      display: flex;
      padding: 10px;
      background: #111;
      border-top: 1px solid #444;
    }
    #userInput {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 4px;
      background: #333;
      color: #eee;
    }
    button {
      margin-left: 8px;
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      background: #007acc;
      color: white;
      cursor: pointer;
    }
    #adminPanel {
      display: none;
      background: #222;
      padding: 10px;
      border-top: 2px solid #007acc;
    }
    #adminPanel h4, #adminPanel label { margin: 6px 0; }
  </style>
</head>
<body>
  <header>🐾 PetGPT (GPT-2 AI)</header>
  <div id="chat"></div>
  <div id="controls">
    <input id="userInput" placeholder="Type your message..." autocomplete="off" />
    <button id="sendBtn">Send</button>
    <button id="resetBtn">Reset</button>
    <button id="voiceBtn">🎤</button>
  </div>
  <div id="adminPanel">
    <h4>Admin Panel (type “cheeto”)</h4>
    <label>Background: <input type="color" id="bgPicker" /></label>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.5.0/dist/transformers.min.js"></script>
  <script>
    let tokenizer, model, gptReady = false;
    const chat = document.getElementById('chat');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const resetBtn = document.getElementById('resetBtn');
    const voiceBtn = document.getElementById('voiceBtn');
    const adminPanel = document.getElementById('adminPanel');
    const bgPicker = document.getElementById('bgPicker');
    let memory = JSON.parse(localStorage.getItem('petgpt-memory') || '{}');

    function append(msg, cls) {
      const d = document.createElement('div');
      d.className = 'message ' + cls;
      d.textContent = msg;
      chat.appendChild(d);
      chat.scrollTop = chat.scrollHeight;
    }

    function saveMem() {
      localStorage.setItem('petgpt-memory', JSON.stringify(memory));
    }

    async function getReply(text) {
      const t = text.toLowerCase();

      if (t.startsWith('remember:')) {
        const [k, v] = t.slice(9).split('=').map(s => s.trim());
        if (k && v) {
          memory[k] = v;
          saveMem();
          return `Got it! I'll remember ${k} = ${v}`;
        }
        return `Use: remember:key=value`;
      }

      for (let k in memory) {
        if (t.includes(k.toLowerCase())) return `You told me ${k} = ${memory[k]}`;
      }

      if (t.includes('cheeto')) {
        adminPanel.style.display = 'block';
        return "Admin panel unlocked!";
      }

      if (gptReady && tokenizer && model) {
        try {
          const encoded = await tokenizer.encode(text);
          const output = await model.generate(encoded.inputIds, {
            max_new_tokens: 50,
            temperature: 0.8,
            top_p: 0.9
          });
          const decoded = await tokenizer.decode(output[0]);
          return decoded.replace(text, '').trim() || "(no reply)";
        } catch (e) {
          console.error("GPT-2 error:", e);
          return "Something went wrong with GPT-2.";
        }
      }

      return "I don't understand that yet.";
    }

    async function sendMessage() {
      const txt = userInput.value.trim();
      if (!txt) return;
      append("You: " + txt, 'user');
      userInput.value = '';
      userInput.disabled = true;
      sendBtn.disabled = true;

      const reply = await getReply(txt);
      append("PetGPT: " + reply, 'bot');

      userInput.disabled = false;
      sendBtn.disabled = false;
      userInput.focus();
    }

    sendBtn.onclick = sendMessage;
    userInput.onkeydown = e => {
      if (e.key === 'Enter') sendMessage();
    };

    resetBtn.onclick = () => {
      if (confirm("Clear chat and memory?")) {
        chat.innerHTML = '';
        memory = {};
        localStorage.clear();
      }
    };

    bgPicker.oninput = e => document.body.style.background = e.target.value;

    // Voice recognition
    let recognition, recognizing = false;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.webkitSpeechRecognition || window.SpeechRecognition;
      recognition = new SR();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.continuous = false;

      recognition.onstart = () => { recognizing = true; voiceBtn.textContent = '🛑'; };
      recognition.onend = () => { recognizing = false; voiceBtn.textContent = '🎤'; };
      recognition.onresult = e => {
        const t = e.results[0][0].transcript;
        userInput.value = t;
        sendMessage();
      };
    }

    voiceBtn.onclick = () => {
      if (!recognition) return alert('Voice recognition not supported.');
      recognizing ? recognition.stop() : recognition.start();
    };

    // Load GPT-2
    append("Loading GPT-2 AI...", "bot");
    window.transformers
      .AutoTokenizer.fromPretrained("gpt2")
      .then(tk => {
        tokenizer = tk;
        return window.transformers.AutoModelForCausalLM.fromPretrained("gpt2");
      })
      .then(m => {
        model = m;
        gptReady = true;
        append("GPT-2 model ready! 🎉", "bot");
      })
      .catch(err => {
        append("Failed to load GPT-2. Fallback only.", "bot");
        console.error(err);
      });
  </script>
</body>
</html>
