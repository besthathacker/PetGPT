<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PetGPT Ultimate - Chat Loading Status</title>
  <style>
    body {
      margin:0; padding:0;
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #eee;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }
    #sidebar {
      width: 280px;
      background: #222;
      display: flex;
      flex-direction: column;
      user-select: none;
    }
    #sidebar header {
      padding: 15px;
      font-size: 1.5em;
      background: #333;
      text-align: center;
    }
    #tabs {
      display: flex;
    }
    #tabs button {
      flex: 1;
      padding: 12px;
      background: #222;
      border: none;
      border-bottom: 2px solid transparent;
      color: #ccc;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s, border-color 0.3s;
    }
    #tabs button.active {
      background: #121212;
      border-bottom: 2px solid #4a90e2;
      color: white;
    }
    #content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #1e1e1e;
    }
    #chatTab {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px 15px;
    }
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      background: #2a2a2a;
      border-radius: 6px;
      margin-bottom: 10px;
      white-space: pre-wrap;
    }
    .message {
      margin-bottom: 10px;
      word-wrap: break-word;
    }
    .message.user {
      text-align: right;
      color: #9fdf9f;
    }
    .message.bot {
      text-align: left;
      color: #df9f9f;
    }
    #chatForm {
      display: flex;
    }
    #userInput {
      flex: 1;
      padding: 10px;
      border-radius: 6px 0 0 6px;
      border: none;
      font-size: 1em;
      outline: none;
    }
    #sendBtn {
      padding: 10px 15px;
      border: none;
      background-color: #4a90e2;
      color: white;
      font-weight: bold;
      border-radius: 0 6px 6px 0;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #sendBtn:disabled {
      background-color: #666;
      cursor: not-allowed;
    }
    #sendBtn:hover:not(:disabled) {
      background-color: #357ABD;
    }
    footer {
      padding: 8px 15px;
      text-align: center;
      background-color: #333;
      font-size: 0.9em;
    }
    /* Image generation tab */
    #imageGenTab {
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    #imagePrompt {
      width: 100%;
      max-width: 600px;
      padding: 10px;
      border-radius: 6px;
      border: none;
      font-size: 1em;
      outline: none;
    }
    #generateBtn {
      padding: 10px 25px;
      background-color: #4a90e2;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    #generateBtn:disabled {
      background-color: #666;
      cursor: not-allowed;
    }
    #generateBtn:hover:not(:disabled) {
      background-color: #357ABD;
    }
    #generatedImage {
      max-width: 100%;
      max-height: 60vh;
      border-radius: 8px;
      margin-top: 10px;
      background: black;
      user-select: none;
    }
    /* File Upload tab */
    #fileUploadTab {
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #fileInput {
      user-select: none;
    }
    #filePreview {
      background: #2a2a2a;
      border-radius: 6px;
      padding: 10px;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      user-select: text;
    }
    #fileImagePreview {
      max-width: 100%;
      border-radius: 6px;
      user-select: none;
    }
    #sendFileToAI {
      padding: 10px 15px;
      background-color: #4a90e2;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    #sendFileToAI:disabled {
      background-color: #666;
      cursor: not-allowed;
    }
    #sendFileToAI:hover:not(:disabled) {
      background-color: #357ABD;
    }
    #aiFileResponse {
      background: #2a2a2a;
      border-radius: 6px;
      padding: 10px;
      white-space: pre-wrap;
      max-height: 150px;
      overflow-y: auto;
      font-family: monospace;
      user-select: text;
    }

    /* Tabs container flex */
    #content > section {
      height: 100%;
    }
    /* Hide non-active tabs */
    [hidden] {
      display: none !important;
    }
  </style>
</head>
<body>

  <!-- Sidebar with tabs -->
  <div id="sidebar" aria-label="Main sidebar">
    <header>PetGPT Ultimate</header>
    <div id="tabs" role="tablist">
      <button id="tabChat" class="active" role="tab" aria-selected="true" aria-controls="chatTab">Chat</button>
      <button id="tabImageGen" role="tab" aria-selected="false" aria-controls="imageGenTab">Image Gen</button>
      <button id="tabFileUpload" role="tab" aria-selected="false" aria-controls="fileUploadTab">File Upload</button>
    </div>
  </div>

  <!-- Content area -->
  <div id="content" role="main">
    <!-- Chat Tab -->
    <section id="chatTab" role="tabpanel" aria-labelledby="tabChat">
      <div id="chatMessages" aria-live="polite" aria-label="Chat messages"></div>
      <form id="chatForm" autocomplete="off">
        <input id="userInput" type="text" placeholder="Type your message..." required autocomplete="off" aria-label="Type your message"/>
        <button type="submit" id="sendBtn" disabled aria-label="Send message">Send</button>
      </form>
    </section>

    <!-- Image Generation Tab -->
    <section id="imageGenTab" role="tabpanel" aria-labelledby="tabImageGen" hidden>
      <input id="imagePrompt" type="text" placeholder="Enter image prompt..." autocomplete="off" aria-label="Image generation prompt" />
      <button id="generateBtn" disabled aria-label="Generate image">Generate Image</button>
      <img id="generatedImage" alt="Generated image will appear here" />
    </section>

    <!-- File Upload Tab -->
    <section id="fileUploadTab" role="tabpanel" aria-labelledby="tabFileUpload" hidden>
      <input id="fileInput" type="file" accept=".txt,.js,.py,.json,.html,.css,.md,.pdf,image/*,text/*" aria-label="Upload a file" />
      <div id="filePreview" hidden aria-live="polite" aria-label="File preview"></div>
      <img id="fileImagePreview" hidden alt="Image preview" />
      <button id="sendFileToAI" disabled aria-label="Send file content to AI for editing or explanation">Send to AI for editing/explanation</button>
      <pre id="aiFileResponse" hidden aria-live="polite" aria-label="AI response to file"></pre>
    </section>
  </div>

  <footer>Â© 2025 PetGPT Ultimate</footer>

<script type="module">
  import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.3.0/dist/transformers.js";
  import { StableDiffusion } from "https://cdn.jsdelivr.net/npm/@xenova/diffusers@0.4.1/dist/diffusers.js";

  // Elements
  const chatMessages = document.getElementById('chatMessages');
  const chatForm = document.getElementById('chatForm');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');

  const imagePrompt = document.getElementById('imagePrompt');
  const generateBtn = document.getElementById('generateBtn');
  const generatedImage = document.getElementById('generatedImage');

  const fileInput = document.getElementById('fileInput');
  const filePreview = document.getElementById('filePreview');
  const fileImagePreview = document.getElementById('fileImagePreview');
  const sendFileToAI = document.getElementById('sendFileToAI');
  const aiFileResponse = document.getElementById('aiFileResponse');

  // Tabs
  const tabChat = document.getElementById('tabChat');
  const tabImageGen = document.getElementById('tabImageGen');
  const tabFileUpload = document.getElementById('tabFileUpload');
  const chatTab = document.getElementById('chatTab');
  const imageGenTab = document.getElementById('imageGenTab');
  const fileUploadTab = document.getElementById('fileUploadTab');

  // State
  let textGenerator = null;
  let stableDiffusion = null;
  let isModelReady = false;

  // Constants
  const MEMORY_KEY = 'petgpt_chat_memory';

  // ----------------
  // Utilities
  // ----------------
  function appendMessage(text, sender) {
    const div = document.createElement('div');
    div.className = 'message ' + sender;
    div.textContent = text;
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  function saveMemory() {
    const messages = [];
    chatMessages.querySelectorAll('.message').forEach(msg => {
      messages.push({
        text: msg.textContent,
        sender: msg.classList.contains('user') ? 'user' : 'bot'
      });
    });
    localStorage.setItem(MEMORY_KEY, JSON.stringify(messages));
  }

  function loadMemory() {
    const data = localStorage.getItem(MEMORY_KEY);
    if (data) {
      try {
        const messages = JSON.parse(data);
        messages.forEach(({ text, sender }) => {
          appendMessage(text, sender);
        });
      } catch {
        localStorage.removeItem(MEMORY_KEY);
      }
    }
  }

  function initializeChatIfEmpty() {
    if (chatMessages.querySelectorAll('.message').length === 0) {
      appendMessage("Hello! I'm PetGPT, ready to chat with you.", "bot");
      saveMemory();
    }
  }

  // ----------------
  // Tab switching logic
  // ----------------
  function setActiveTab(tabButton) {
    tabChat.hidden = true;
    imageGenTab.hidden = true;
    fileUploadTab.hidden = true;

    tabChat.classList.remove('active');
    tabImageGen.classList.remove('active');
    tabFileUpload.classList.remove('active');

    if (tabButton === tabChat) {
      chatTab.hidden = false;
      tabChat.classList.add('active');
      tabChat.setAttribute('aria-selected', 'true');
    } else if (tabButton === tabImageGen) {
      imageGenTab.hidden = false;
      tabImageGen.classList.add('active');
      tabImageGen.setAttribute('aria-selected', 'true');
    } else if (tabButton === tabFileUpload) {
      fileUploadTab.hidden = false;
      tabFileUpload.classList.add('active');
      tabFileUpload.setAttribute('aria-selected', 'true');
    }
    // Set others aria-selected false
    [tabChat, tabImageGen, tabFileUpload].forEach(btn => {
      if (btn !== tabButton) btn.setAttribute('aria-selected', 'false');
    });
  }

  tabChat.addEventListener('click', () => setActiveTab(tabChat));
  tabImageGen.addEventListener('click', () => setActiveTab(tabImageGen));
  tabFileUpload.addEventListener('click', () => setActiveTab(tabFileUpload));

  // ----------------
  // Model Loading
  // ----------------
  async function loadModels() {
    // Show loading message inside chat
    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'message bot';
    loadingMsg.textContent = 'Loading models, please wait...';
    chatMessages.appendChild(loadingMsg);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    try {
      textGenerator = await pipeline('text-generation', 'Xenova/gpt-2');
      stableDiffusion = await StableDiffusion.create();

      // Remove loading message on success
      loadingMsg.remove();

      isModelReady = true;
      updateButtonStates();

    } catch (e) {
      console.error('Model load error:', e);
      loadingMsg.textContent = 'Failed to load models, please try refreshing.';
    }
  }

  // ----------------
  // Button state update
  // ----------------
  function updateButtonStates() {
    sendBtn.disabled = !isModelReady || userInput.value.trim() === '';
    generateBtn.disabled = !isModelReady || imagePrompt.value.trim() === '';
    sendFileToAI.disabled = !isModelReady || !fileInput.files.length || !filePreview.textContent.trim();
  }

  // ----------------
  // Chat logic
  // ----------------
  chatForm.addEventListener('submit', async e => {
    e.preventDefault();
    if (!isModelReady) return;

    const prompt = userInput.value.trim();
    if (!prompt) return;

    appendMessage(prompt, 'user');
    saveMemory();

    userInput.value = '';
    updateButtonStates();

    appendMessage('...', 'bot');
    saveMemory();

    try {
      const output = await textGenerator(prompt, {
        max_new_tokens: 80,
        do_sample: true,
        temperature: 0.7
      });
      const lastBotMsg = chatMessages.querySelector('.message.bot:last-child');
      const response = output[0]?.generated_text.slice(prompt.length).trim() || "(No response)";
      lastBotMsg.textContent = response;
      saveMemory();
    } catch (e) {
      console.error('Error during text generation:', e);
      const lastBotMsg = chatMessages.querySelector('.message.bot:last-child');
      lastBotMsg.textContent = "(Error generating response)";
    }
  });

  userInput.addEventListener('input', updateButtonStates);

  // ----------------
  // Image generation logic
  // ----------------
  generateBtn.addEventListener('click', async () => {
    if (!isModelReady) return;

    const prompt = imagePrompt.value.trim();
    if (!prompt) return;

    generateBtn.disabled = true;
    generatedImage.src = '';
    generatedImage.alt = 'Generating image...';

    try {
      const result = await stableDiffusion.textToImage(prompt, {width:512, height:512});
      // result is a HTMLImageElement
      generatedImage.src = result.src;
      generatedImage.alt = 'Generated image';
    } catch (e) {
      console.error('Error generating image:', e);
      generatedImage.alt = 'Error generating image';
      alert('Image generation failed, check console.');
    }

    generateBtn.disabled = false;
  });

  imagePrompt.addEventListener('input', updateButtonStates);

  // ----------------
  // File upload and preview logic
  // ----------------
  function isCodeFile(filename) {
    return /\.(js|py|json|html|css|md|txt)$/i.test(filename);
  }

  let pdfjsLib;
  async function loadPDFjs() {
    if (pdfjsLib) return;
    pdfjsLib = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js');
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';
  }

  async function extractTextFromPDF(file) {
    await loadPDFjs();
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
    let text = '';
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      for (const item of content.items) {
        text += item.str + ' ';
      }
      text += '\n\n';
    }
    return text.trim();
  }

  fileInput.addEventListener('change', async () => {
    sendFileToAI.disabled = true;
    aiFileResponse.hidden = true;
    aiFileResponse.textContent = '';
    filePreview.hidden = true;
    fileImagePreview.hidden = true;

    if (!fileInput.files.length) return;

    const file = fileInput.files[0];
    const type = file.type;

    if (type.startsWith('image/')) {
      // Show image preview
      const url = URL.createObjectURL(file);
      fileImagePreview.src = url;
      fileImagePreview.hidden = false;
      filePreview.hidden = true;
      sendFileToAI.disabled = false;
    } else if (type === 'application/pdf') {
      // Extract PDF text
      try {
        const text = await extractTextFromPDF(file);
        filePreview.textContent = text || "(No extractable text)";
        filePreview.hidden = false;
        fileImagePreview.hidden = true;
        sendFileToAI.disabled = text.trim() !== '';
      } catch {
        filePreview.textContent = "(Failed to extract PDF text)";
        filePreview.hidden = false;
        fileImagePreview.hidden = true;
        sendFileToAI.disabled = false;
      }
    } else if (isCodeFile(file.name) || type.startsWith('text/')) {
      // Read text/code file
      const text = await file.text();
      filePreview.textContent = text || "(Empty file)";
      filePreview.hidden = false;
      fileImagePreview.hidden = true;
      sendFileToAI.disabled = text.trim() !== '';
    } else {
      filePreview.textContent = "(Unsupported file type)";
      filePreview.hidden = false;
      fileImagePreview.hidden = true;
      sendFileToAI.disabled = true;
    }
  });

  sendFileToAI.addEventListener('click', async () => {
    if (!isModelReady) return;
    sendFileToAI.disabled = true;
    aiFileResponse.hidden = true;
    aiFileResponse.textContent = '';

    let prompt = '';

    if (!fileInput.files[0]) {
      alert("No file loaded.");
      sendFileToAI.disabled = false;
      return;
    }

    const file = fileInput.files[0];
    if (file.type.startsWith('image/')) {
      alert("Image editing via AI is not yet implemented here.");
      sendFileToAI.disabled = false;
      return;
    } else {
      prompt = filePreview.textContent.trim();
      if (!prompt) {
        alert("File preview is empty.");
        sendFileToAI.disabled = false;
        return;
      }
    }

    appendMessage("File content sent for AI analysis...", "user");

    try {
      const output = await textGenerator(prompt, {
        max_new_tokens: 150,
        do_sample: true,
        temperature: 0.7
      });
      const reply = output[0]?.generated_text.slice(prompt.length).trim() || "(No response)";
      aiFileResponse.textContent = reply;
      aiFileResponse.hidden = false;
      appendMessage(reply, "bot");
      saveMemory();
    } catch (e) {
      aiFileResponse.textContent = "(Error generating response)";
      aiFileResponse.hidden = false;
      console.error(e);
    }

    sendFileToAI.disabled = false;
  });

  // ----------------
  // Initialize app on window load
  // ----------------
  async function initApp() {
    loadMemory();
    setActiveTab(tabChat);
    updateButtonStates();
    await loadModels();
    initializeChatIfEmpty();
    updateButtonStates();
  }

  window.onload = initApp;

</script>

</body>
</html>
