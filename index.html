<!DOCTYPE html>
<html lang="en">
<head>
<head>
  <!-- Meta for PWA -->
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />

  <!-- Add service worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js');
      });
    }
  </script>
</head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PetGPT Ultimate</title>
<style>
  /* Basic styling */
  body {
    margin: 0; padding: 0; font-family: Arial, sans-serif;
    background: #1e1e1e; color: white; display: flex; height: 100vh;
  }
  #sidebar {
    width: 280px; background: #2b2b2b; padding: 1rem; box-sizing: border-box;
    display: flex; flex-direction: column;
  }
  #chatContainer {
    flex: 1; display: flex; flex-direction: column;
  }
  #chat {
    flex: 1; overflow-y: auto; padding: 1rem; background: #222;
    display: flex; flex-direction: column; gap: 10px;
  }
  .message {
    max-width: 70%; padding: 10px 14px; border-radius: 8px; word-break: break-word;
  }
  .user { background: #3a3a3a; align-self: flex-end; }
  .bot { background: #007acc; align-self: flex-start; }
  .chat-image {
    max-width: 200px; margin-top: 6px; border-radius: 6px;
  }
  #controls {
    background: #111; padding: 10px; display: flex; gap: 10px;
  }
  #userInput {
    flex: 1; padding: 8px; border-radius: 4px; border: none;
    background: #333; color: white; font-size: 1rem;
  }
  button, select {
    background: #007acc; border: none; color: white; padding: 8px 12px;
    border-radius: 4px; cursor: pointer;
  }
  button:disabled {
    opacity: 0.5; cursor: not-allowed;
  }
  #fileInput {
    display: none;
  }
  label[for="fileInput"] {
    background: #007acc;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
  }
  #modelSelect, #personalitySelect {
    margin-bottom: 1rem;
  }
</style>
</head>
<body>

<div id="sidebar">
  <h2>PetGPT Ultimate</h2>
  <label for="modelSelect">Choose AI Model:</label>
  <select id="modelSelect" aria-label="AI model selector">
    <option value="gpt2">GPT-2 Small (Local)</option>
    <option value="deepai-textgen">DeepAI Text Generation (API)</option>
    <option value="deepai-imageedit">DeepAI Image Editing (API)</option>
  </select>
  <label for="personalitySelect">Personality:</label>
  <select id="personalitySelect" aria-label="AI personality selector">
    <option value="friendly">Friendly</option>
    <option value="roast">Roast</option>
  </select>

  <label for="fileInput" title="Upload file (images, PDFs, code)">ðŸ“Ž Upload File</label>
  <input type="file" id="fileInput" aria-label="Upload file" />

</div>

<div id="chatContainer">
  <div id="chat" aria-live="polite" aria-label="Chat messages"></div>
  <div id="controls">
    <input id="userInput" type="text" placeholder="Type your message..." aria-label="User input" autocomplete="off" />
    <button id="sendBtn" aria-label="Send message" type="button">Send</button>
  </div>
</div>

<script type="module">
  // Your DeepAI API key here:
  const DEEPAI_API_KEY = '8c839b12-749b-46be-a333-404236941b8b';

  const chat = document.getElementById('chat');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const modelSelect = document.getElementById('modelSelect');
  const personalitySelect = document.getElementById('personalitySelect');
  const fileInput = document.getElementById('fileInput');

  let localGPT2Pipeline = null;
  let gpt2Loading = false;

  // Append message to chat area
  function appendMessage(sender, text) {
    const div = document.createElement('div');
    div.className = 'message ' + sender;
    if (sender === 'bot' && typeof text === 'string') {
      // Detect image URLs and show inline images
      const urlRegex = /(https?:\/\/\S+\.(?:png|jpg|jpeg|gif|webp))/gi;
      const matches = text.match(urlRegex);
      if (matches) {
        div.textContent = '';
        matches.forEach(url => {
          const img = document.createElement('img');
          img.src = url;
          img.alt = 'Generated image';
          img.className = 'chat-image';
          div.appendChild(img);
          div.appendChild(document.createElement('br'));
        });
        // Remove image URLs from text to avoid duplication
        text = text.replace(urlRegex, '').trim();
        if (text) {
          const p = document.createElement('p');
          p.textContent = text;
          div.appendChild(p);
        }
      } else {
        div.textContent = text;
      }
    } else {
      div.textContent = text;
    }
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  // Load GPT-2 small model locally using Xenova Transformers
  async function loadGPT2() {
    if (gpt2Loading) return;
    gpt2Loading = true;
    appendMessage('bot', 'Loading GPT-2 small model locally, please wait...');
    try {
      const { pipeline } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.5.0/dist/transformers.min.js');
      localGPT2Pipeline = await pipeline('text-generation', 'Xenova/gpt2');
      appendMessage('bot', 'GPT-2 small model loaded!');
    } catch (e) {
      console.error('Failed to load GPT-2:', e);
      appendMessage('bot', 'Failed to load GPT-2 model, switching to DeepAI API.');
      localGPT2Pipeline = null;
      modelSelect.value = 'deepai-textgen';
    }
    gpt2Loading = false;
  }

  // Generate reply depending on selected model
  async function generateReply(prompt) {
    if (modelSelect.value === 'gpt2') {
      if (!localGPT2Pipeline) {
        await loadGPT2();
        if (!localGPT2Pipeline) {
          modelSelect.value = 'deepai-textgen';
          appendMessage('bot', 'Switched to DeepAI Text Generation API due to GPT-2 load failure.');
          return "Sorry, GPT-2 model failed to load.";
        }
      }
      try {
        const output = await localGPT2Pipeline(prompt, {
          max_new_tokens: 100,
          temperature: 0.7,
          top_k: 50,
          top_p: 0.9,
          repetition_penalty: 1.2,
          stop: ['\n', '</s>'],
        });
        let reply = output[0].generated_text.replace(prompt, '').trim();
        if (!reply) reply = "Sorry, I didn't understand that. Could you rephrase?";
        return reply;
      } catch (e) {
        console.error('GPT-2 generation error:', e);
        return "Sorry, something went wrong with the AI.";
      }
    }

    if (modelSelect.value === 'deepai-textgen') {
      try {
        const res = await fetch('https://api.deepai.org/api/text-generator', {
          method: 'POST',
          headers: {
            'api-key': DEEPAI_API_KEY,
            'Accept': 'application/json',
          },
          body: new URLSearchParams({ text: prompt }),
        });
        const data = await res.json();
        if (data.output) {
          return data.output.trim();
        } else {
          return "Sorry, I couldn't generate a response.";
        }
      } catch (e) {
        console.error('DeepAI text gen error:', e);
        return "Error contacting DeepAI API.";
      }
    }

    if (modelSelect.value === 'deepai-imageedit') {
      // For image editing, prompt input isn't used
      return "Upload an image file to edit using DeepAI Image Editing API.";
    }

    return "Selected AI model is not supported.";
  }

  // Handle sending message
  async function sendMessage() {
    const text = userInput.value.trim();
    if (!text) return;

    appendMessage('user', text);
    userInput.value = '';
    sendBtn.disabled = true;
    userInput.disabled = true;

    // Build prompt based on personality
    let prompt = text;
    if (personalitySelect.value === 'roast') {
      prompt = `You are a playful AI that roasts the user politely.\nUser: ${text}\nAI:`;
    } else {
      prompt = `You are a friendly helpful AI.\nUser: ${text}\nAI:`;
    }

    try {
      const reply = await generateReply(prompt);
      appendMessage('bot', reply);
    } catch (e) {
      appendMessage('bot', 'Sorry, an error occurred.');
      console.error(e);
    } finally {
      sendBtn.disabled = false;
      userInput.disabled = false;
      userInput.focus();
    }
  }

  // File upload handler
  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    appendMessage('user', `Uploaded file: ${file.name}`);

    if (modelSelect.value === 'deepai-imageedit' && file.type.startsWith('image/')) {
      // DeepAI Image Editing API call
      try {
        const formData = new FormData();
        formData.append('image', file);
        const res = await fetch('https://api.deepai.org/api/image-editor', {
          method: 'POST',
          headers: { 'api-key': DEEPAI_API_KEY },
          body: formData,
        });
        const data = await res.json();
        if (data.output_url) {
          appendMessage('bot', 'Image edited successfully:');
          const img = document.createElement('img');
          img.src = data.output_url;
          img.alt = 'Edited image';
          img.className = 'chat-image';
          chat.appendChild(img);
          chat.scrollTop = chat.scrollHeight;
        } else {
          appendMessage('bot', 'Failed to edit image. Try again.');
        }
      } catch (e) {
        console.error('DeepAI image editing error:', e);
        appendMessage('bot', 'Error contacting DeepAI Image Editing API.');
      }
    } else if (modelSelect.value === 'deepai-textgen' && file.type.startsWith('image/')) {
      // Image captioning with DeepAI NeuralTalk API
      try {
        const formData = new FormData();
        formData.append('image', file);
        const res = await fetch('https://api.deepai.org/api/neuraltalk', {
          method: 'POST',
          headers: { 'api-key': DEEPAI_API_KEY },
          body: formData,
        });
        const data = await res.json();
        if (data.output) {
          appendMessage('bot', `Image description: ${data.output}`);
        } else {
          appendMessage('bot', 'Could not generate description for the image.');
        }
      } catch (e) {
        console.error('DeepAI NeuralTalk error:', e);
        appendMessage('bot', 'Error contacting DeepAI image captioning API.');
      }
    } else if (file.type === 'application/pdf') {
      // PDF text extraction and summarization
      const reader = new FileReader();
      reader.onload = async () => {
        const textContent = reader.result;
        appendMessage('bot', 'PDF content loaded, processing...');
        const summaryPrompt = `Summarize this PDF content:\n\n${textContent.slice(0, 3000)}`;
        const summary = await generateReply(summaryPrompt);
        appendMessage('bot', `Summary:\n${summary}`);
      };
      reader.readAsText(file);
    } else {
      // Treat as text/code file
      const reader = new FileReader();
      reader.onload = async () => {
        const textContent = reader.result;
        appendMessage('bot', 'Code/Text file content received, processing...');
        const codePrompt = `Help me understand or improve this code:\n\n${textContent.slice(0, 3000)}`;
        const helpReply = await generateReply(codePrompt);
        appendMessage('bot', helpReply);
      };
      reader.readAsText(file);
    }

    fileInput.value = ''; // reset input
  });

  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendMessage();
    }
  });

  // Load GPT-2 on startup if selected
  async function init() {
    if (modelSelect.value === 'gpt2') {
      await loadGPT2();
    } else {
      appendMessage('bot', 'Using DeepAI API.');
    }
    userInput.focus();
  }

  modelSelect.addEventListener('change', async () => {
    appendMessage('bot', `Switched to model: ${modelSelect.value}`);
    if (modelSelect.value === 'gpt2' && !localGPT2Pipeline) {
      await loadGPT2();
    }
  });

  personalitySelect.addEventListener('change', () => {
    appendMessage('bot', `Personality changed to: ${personalitySelect.value}`);
  });

  init();

</script>

</body>
</html>
