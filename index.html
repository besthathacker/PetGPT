<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PetGPT Ultimate</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: white;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    header, footer {
      background: #007acc;
      padding: 1rem;
      text-align: center;
      font-size: 1.4rem;
      flex-shrink: 0;
      user-select: none;
    }
    #app-container {
      flex: 1 1 auto;
      display: flex;
      height: calc(100vh - 112px);
      overflow: hidden;
    }
    /* Sidebar */
    #chat-sidebar {
      width: 260px;
      background: #2b2b2b;
      border-right: 1px solid #444;
      display: flex;
      flex-direction: column;
    }
    #sidebar-header {
      padding: 10px;
      font-weight: bold;
      font-size: 1.25rem;
      color: #90caf9;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      border-bottom: 1px solid #444;
    }
    #btn-new-chat {
      background: #007acc;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1.2rem;
      line-height: 1;
      user-select: none;
    }
    #chat-list {
      flex-grow: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .chat-item {
      background: #3a3a3a;
      margin: 6px 12px;
      padding: 8px 12px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background-color 0.2s ease;
      user-select: none;
    }
    .chat-item:hover {
      background: #4a90e2;
      color: white;
    }
    .chat-item.active {
      background: #90caf9;
      color: #121212;
      font-weight: bold;
    }
    .chat-title {
      flex-grow: 1;
      outline: none;
      user-select: text;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: text;
      margin-right: 8px;
    }
    .chat-title:focus {
      background: #555;
      border-radius: 3px;
      color: white;
    }
    .btn-delete-chat {
      background: transparent;
      border: none;
      color: #f44336;
      font-weight: bold;
      cursor: pointer;
      font-size: 1.1rem;
      user-select: none;
      line-height: 1;
    }
    .btn-delete-chat:hover {
      color: #ff7961;
    }
    /* Main Chat Area */
    #chat-main {
      flex-grow: 1;
      background: #2b2b2b;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #chat {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 10px;
      background: #2b2b2b;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .message {
      max-width: 75%;
      padding: 8px 12px;
      border-radius: 6px;
      word-wrap: break-word;
      user-select: text;
    }
    .user {
      background: #3a3a3a;
      align-self: flex-end;
    }
    .bot {
      background: #007acc;
      align-self: flex-start;
    }
    #controls {
      flex-shrink: 0;
      background: #111;
      border-top: 1px solid #444;
      display: flex;
      padding: 10px;
      gap: 6px;
      align-items: center;
    }
    #userInput {
      flex: 1 1 auto;
      padding: 8px;
      border-radius: 4px;
      border: none;
      background: #333;
      color: #eee;
      font-size: 1rem;
    }
    #userInput::placeholder {
      color: #aaa;
    }
    button {
      background: #007acc;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      flex-shrink: 0;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #adminPanel {
      display: none;
      background: #333;
      padding: 10px;
      border-top: 2px solid #007acc;
      font-size: 0.9rem;
      overflow-y: auto;
      max-height: 200px;
    }
    #adminPanel h4 {
      margin: 0.5rem 0 0.25rem 0;
    }
    #adminPanel label {
      display: block;
      margin-bottom: 0.75rem;
    }
    /* Game grids basic styling */
    #matchGrid, #solBoard, #drGrid {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      background: #222;
      border-radius: 6px;
      padding: 6px;
    }
    #matchGrid div, #solBoard div, #drGrid div {
      width: 30px;
      height: 30px;
      background: #555;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: #ccc;
    }
  </style>
</head>
<body>

<header>PetGPT Ultimate</header>

<div id="app-container">
  <nav id="chat-sidebar" aria-label="Chat list">
    <div id="sidebar-header">
      Chats
      <button id="btn-new-chat" title="New Chat">Ôºã</button>
    </div>
    <div id="chat-list" role="list"></div>
  </nav>

  <main id="chat-main">
    <div id="chat" aria-live="polite" aria-label="Chat messages"></div>
    <div id="controls">
      <input id="userInput" type="text" placeholder="Type your message..." autocomplete="off" aria-label="User input" />
      <button id="sendBtn" aria-label="Send message" type="button" disabled>Send</button>
    </div>
  </main>
</div>

<div id="adminPanel" aria-hidden="true" aria-label="Admin panel">
  <h4>Admin Panel (unlock with "cheeto")</h4>

  <h4>üéÆ Match Game</h4>
  <div id="matchScore" style="color:#8f8;">Score:0 | Best:0</div>
  <div class="grid" id="matchGrid"></div>

  <h4>üÉè Solitaire</h4>
  <div id="solScore" style="color:#88f;">Score:0 | Best:0</div>
  <div class="solitaire" id="solBoard"></div>

  <h4>üß™ Dr. Mario Pill-Swap</h4>
  <div id="drScore" style="color:#fa0;">Score:0 | Best:0</div>
  <div class="drgrid" id="drGrid"></div>

  <button id="drToggle">‚ñ∂Ô∏è Play Theme</button>
  <audio id="drAudio" loop>
    <source src="https://actions.google.com/sounds/v1/video_game/atari_breakout_theme.ogg" type="audio/ogg" />
  </audio>

  <label>Background Color: <input type="color" id="bgPicker" aria-label="Background color picker" /></label>
</div>

<footer>¬© 2025 PetGPT Ultimate</footer>

<script type="module">
  import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.5.0';

  // Elements
  const chat = document.getElementById('chat');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const adminPanel = document.getElementById('adminPanel');
  const bgPicker = document.getElementById('bgPicker');
  const btnNewChat = document.getElementById('btn-new-chat');
  const chatListEl = document.getElementById('chat-list');

  // Storage keys
  const STORAGE_CHATS = 'petgpt-chats';
  const STORAGE_ACTIVE_CHAT = 'petgpt-activeChat';
  const STORAGE_MEMORY = 'petgpt-memory';

  // Chats data structure
  // Format: { chatId: { title: string, messages: [{role: 'user'|'bot', content: string}] } }
  let chats = JSON.parse(localStorage.getItem(STORAGE_CHATS) || '{}');
  let activeChatId = localStorage.getItem(STORAGE_ACTIVE_CHAT);

  if (!chats || Object.keys(chats).length === 0) {
    // Initialize with one chat if none
    const initialId = 'chat-' + Date.now();
    chats = {
      [initialId]: {
        title: 'New Chat',
        messages: []
      }
    };
    activeChatId = initialId;
    saveChats();
  }

  // Save chats and active chat ID
  function saveChats() {
    localStorage.setItem(STORAGE_CHATS, JSON.stringify(chats));
    localStorage.setItem(STORAGE_ACTIVE_CHAT, activeChatId);
  }

  // Render chat list sidebar
  function renderChatList() {
    chatListEl.innerHTML = '';
    const keys = Object.keys(chats);
    if (keys.length === 0) {
      chatListEl.innerHTML = '<p style="color:#888; padding:10px;">No chats. Click + to start one.</p>';
      clearChatWindow();
      return;
    }
    keys.forEach(id => {
      const chatData = chats[id];
      const chatDiv = document.createElement('div');
      chatDiv.className = 'chat-item';
      if (id === activeChatId) chatDiv.classList.add('active');
      chatDiv.dataset.chatId = id;

      // Editable title
      const titleSpan = document.createElement('span');
      titleSpan.className = 'chat-title';
      titleSpan.contentEditable = true;
      titleSpan.spellcheck = false;
      titleSpan.textContent = chatData.title;
      titleSpan.title = 'Click to rename';
      titleSpan.addEventListener('blur', () => {
        const newTitle = titleSpan.textContent.trim();
        chats[id].title = newTitle.length > 0 ? newTitle : 'Untitled Chat';
        saveChats();
        renderChatList();
      });
      titleSpan.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          titleSpan.blur();
        }
      });

      // Delete button
      const delBtn = document.createElement('button');
      delBtn.className = 'btn-delete-chat';
      delBtn.title = 'Delete chat';
      delBtn.textContent = '‚úñ';
      delBtn.addEventListener('click', e => {
        e.stopPropagation();
        if (confirm(`Delete chat "${chatData.title}"?`)) {
          delete chats[id];
          // If deleted chat was active, switch to another or clear
          if (activeChatId === id) {
            const remaining = Object.keys(chats);
            activeChatId = remaining.length ? remaining[0] : null;
          }
          saveChats();
          renderChatList();
          if (activeChatId) loadChat(activeChatId);
          else clearChatWindow();
        }
      });

      // Click selects chat
      chatDiv.addEventListener('click', () => {
        if (activeChatId !== id) {
          activeChatId = id;
          saveChats();
          renderChatList();
          loadChat(id);
        }
      });

      chatDiv.appendChild(titleSpan);
      chatDiv.appendChild(delBtn);
      chatListEl.appendChild(chatDiv);
    });
  }

  // Clear chat window
  function clearChatWindow() {
    chat.innerHTML = '<p style="color:#888;">No active chat. Create one!</p>';
    sendBtn.disabled = true;
    userInput.value = '';
    userInput.disabled = true;
  }

  // Load chat messages into main chat window
  function loadChat(id) {
    const chatData = chats[id];
    if (!chatData) {
      clearChatWindow();
      return;
    }
    chat.innerHTML = '';
    if (chatData.messages.length === 0) {
      chat.innerHTML = '<p style="color:#888;">No messages yet. Say hi!</p>';
      sendBtn.disabled = false;
      userInput.disabled = false;
      userInput.value = '';
      userInput.focus();
      return;
    }
    chatData.messages.forEach(msg => {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + (msg.role === 'user' ? 'user' : 'bot');
      msgDiv.textContent = msg.content;
      chat.appendChild(msgDiv);
    });
    chat.scrollTop = chat.scrollHeight;
    sendBtn.disabled = false;
    userInput.disabled = false;
    userInput.value = '';
    userInput.focus();
  }

  // Add message to active chat
  function addMessageToActiveChat(role, content) {
    if (!activeChatId) {
      // Create new chat if none active
      createNewChat();
    }
    chats[activeChatId].messages.push({ role, content });
    saveChats();
  }

  // Create new chat and select it
  function createNewChat() {
    const id = 'chat-' + Date.now();
    chats[id] = { title: 'New Chat', messages: [] };
    activeChatId = id;
    saveChats();
    renderChatList();
    loadChat(id);
  }

  // Enable/disable send button on input change
  userInput.addEventListener('input', () => {
    sendBtn.disabled = userInput.value.trim() === '';
  });

  // Send message handler (with your existing AI integration)
  async function sendMessage() {
    const text = userInput.value.trim();
    if (!text) return;

    addMessageToActiveChat('user', text);
    renderChatList();
    loadChat(activeChatId);

    userInput.disabled = true;
    sendBtn.disabled = true;

    try {
      // Your existing getReply() function is async, so let's reuse it
      const reply = await getReply(text);
      addMessageToActiveChat('bot', reply);
      renderChatList();
      loadChat(activeChatId);
    } catch (err) {
      addMessageToActiveChat('bot', 'Sorry, an error occurred.');
      console.error(err);
      renderChatList();
      loadChat(activeChatId);
    } finally {
      userInput.disabled = false;
      sendBtn.disabled = false;
      userInput.value = '';
      userInput.focus();
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (!sendBtn.disabled) sendMessage();
    }
  });
  btnNewChat.addEventListener('click', () => {
    createNewChat();
  });

  // Initialize UI
  function init() {
    if (!activeChatId || !chats[activeChatId]) {
      const keys = Object.keys(chats);
      if (keys.length > 0) activeChatId = keys[0];
      else createNewChat();
    }
    renderChatList();
    if (activeChatId) loadChat(activeChatId);
    else clearChatWindow();
  }

  // ---------------- Your existing AI and memory code -------------------

  let generator, gptReady = false;
  let memory = JSON.parse(localStorage.getItem(STORAGE_MEMORY) || '{}');

  // Profanity and toxicity filtering
  const rudeWords = [
    "stupid", "idiot", "dumb", "hate you", "shut up", "go away",
    "useless", "worthless", "annoying", "nobody likes", "you're bad",
    "kill", "die", "ugly", "fat", "dumbest", "jerk", "moron", "trash"
  ];

  function sanitizeMeanWords(text) {
    let result = text;
    rudeWords.forEach(word => {
      const regex = new RegExp("\\b" + word + "\\b", "gi");
      result = result.replace(regex, "[MEOW]");
    });
    return result;
  }

  function filterToxicSentences(text) {
    const sentences = text.split(/(?<=[.!?])\s+/);
    const filtered = sentences.map(sentence => {
      const lower = sentence.toLowerCase();
      if (rudeWords.some(word => lower.includes(word))) {
        return "That wasn't very nice, meow!";
      }
      return sentence;
    });
    return filtered.join(" ");
  }

  function isWeirdResponse(reply) {
    return !reply || reply.trim() === "" || /^(\W|[a-zA-Z0-9])\1+$/.test(reply);
  }

  // Your extended dictionary for canned replies
  const extendedDictionary = {
    hello: "Hello, friend! üêæ",
    hi: "Hi there! üòä",
    hey: "Hey hey! üò∫",
    "how are you": "I'm purr-fectly fine! How about you?",
    "good morning": "Good morning! Hope you slept well. ‚òÄÔ∏è",
    "good night": "Good night! Sweet dreams. üåô"
  };

  // DuckDuckGo fallback
  async function duckDuckGoFallback(query) {
    try {
      const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json`);
      const data = await response.json();
      return data.Abstract || data.Answer || data.RelatedTopics?.[0]?.Text || null;
    } catch {
      return null;
    }
  }

  // Load GPT-2 model once and reuse
  async function loadModel() {
    if (generator) return;
    try {
      generator = await pipeline("text-generation", "Xenova/gpt2");
      gptReady = true;
      console.log("GPT-2 model loaded");
    } catch (e) {
      console.warn("Failed to load GPT-2 model:", e);
    }
  }
  loadModel();

  // Get reply from local model or fallback
  async function getReply(message) {
    // Check canned polite replies first
    const lowerMsg = message.trim().toLowerCase();
    if (extendedDictionary[lowerMsg]) return extendedDictionary[lowerMsg];

    // Try GPT-2 local model if ready
    if (gptReady && generator) {
      try {
        const result = await generator(message, { max_new_tokens: 100 });
        let reply = result[0]?.generated_text?.replace(message, "").trim();
        if (!isWeirdResponse(reply)) {
          reply = filterToxicSentences(sanitizeMeanWords(reply));
          return reply;
        }
      } catch (e) {
        console.warn("Local model generation error:", e);
      }
    }

    // Try DuckDuckGo fallback
    const ddgReply = await duckDuckGoFallback(message);
    if (ddgReply) return filterToxicSentences(sanitizeMeanWords(ddgReply));

    // Final fallback
    return "MEOW! Sorry, I don't know the answer to that.";
  }

  // ---------------- Admin Panel / Games / Background --------------------

  // Admin panel toggle by typing "cheeto" sequence
  let keyBuffer = "";
  document.addEventListener("keydown", e => {
    if (e.key.length === 1) {
      keyBuffer += e.key.toLowerCase();
      if (keyBuffer.length > 20) keyBuffer = keyBuffer.slice(-20);
      if (keyBuffer.includes("cheeto")) {
        if (adminPanel.style.display === "block") {
          adminPanel.style.display = "none";
          adminPanel.setAttribute("aria-hidden", "true");
        } else {
          adminPanel.style.display = "block";
          adminPanel.setAttribute("aria-hidden", "false");
        }
        keyBuffer = "";
      }
    }
  });

  // Background color picker
  bgPicker.value = "#1e1e1e";
  bgPicker.addEventListener("input", e => {
    document.body.style.background = e.target.value;
  });

  // --- Dummy implementations for Match Game, Solitaire, Dr. Mario ---
  // These are placeholders. You can expand or replace with your full game logic.

  // Match Game
  const matchGrid = document.getElementById("matchGrid");
  const matchScoreEl = document.getElementById("matchScore");
  let matchScore = 0;
  let matchBest = 0;

  function setupMatchGame() {
    matchGrid.innerHTML = "";
    for (let i = 0; i < 16; i++) {
      const div = document.createElement("div");
      div.textContent = "?";
      div.title = "Match tile";
      div.addEventListener("click", () => {
        matchScore += 1;
        matchBest = Math.max(matchBest, matchScore);
        matchScoreEl.textContent = `Score:${matchScore} | Best:${matchBest}`;
      });
      matchGrid.appendChild(div);
    }
  }
  setupMatchGame();

  // Solitaire
  const solBoard = document.getElementById("solBoard");
  const solScoreEl = document.getElementById("solScore");
  let solScore = 0;
  let solBest = 0;
  function setupSolitaire() {
    solBoard.innerHTML = "";
    for (let i = 0; i < 28; i++) {
      const div = document.createElement("div");
      div.textContent = "üÇ†";
      div.title = "Solitaire card";
      div.addEventListener("click", () => {
        solScore += 2;
        solBest = Math.max(solBest, solScore);
        solScoreEl.textContent = `Score:${solScore} | Best:${solBest}`;
      });
      solBoard.appendChild(div);
    }
  }
  setupSolitaire();

  // Dr. Mario Pill Swap
  const drGrid = document.getElementById("drGrid");
  const drScoreEl = document.getElementById("drScore");
  let drScore = 0;
  let drBest = 0;
  function setupDrMario() {
    drGrid.innerHTML = "";
    for (let i = 0; i < 20; i++) {
      const div = document.createElement("div");
      div.textContent = "üíä";
      div.title = "Dr. Mario pill";
      div.addEventListener("click", () => {
        drScore += 3;
        drBest = Math.max(drBest, drScore);
        drScoreEl.textContent = `Score:${drScore} | Best:${drBest}`;
      });
      drGrid.appendChild(div);
    }
  }
  setupDrMario();

  // Dr. Mario theme music toggle
  const drAudio = document.getElementById("drAudio");
  const drToggle = document.getElementById("drToggle");
  drToggle.addEventListener("click", () => {
    if (drAudio.paused) {
      drAudio.play();
      drToggle.textContent = "‚è∏Ô∏è Pause Theme";
    } else {
      drAudio.pause();
      drToggle.textContent = "‚ñ∂Ô∏è Play Theme";
    }
  });

  // ----------------- Init all -----------------
  init();
</script>

</body>
</html>
