<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PetGPT Ultimate</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="petgpt-icon-512.png" type="image/png" />
  <meta name="theme-color" content="#000000" />
  <style>
    /* Styles as before (sidebar, chat, modal, inputs) */
  </style>
</head>
<body>
  <!-- Sidebar + chat UI -->
  <div id="sidebar">…</div>
  <div id="main">…</div>
  <!-- Image Modal -->
  <div id="imageModal">…</div>

  <script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.3.0/dist/transformers.min.js';
    import { DiffusionPipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/diffusers/dist/diffusers.min.js';

    let chats = [], activeId, genModel, imgPipeline;

    // Load/create chats
    function loadChats() {
      const s = localStorage.getItem('petgpt_chats');
      chats = s ? JSON.parse(s) : [];
      if (!chats.length) chats = [{ id: Date.now()+'', title: 'New Chat', messages: [] }];
      activeId = chats[0].id;
    }

    function saveChats() {
      localStorage.setItem('petgpt_chats', JSON.stringify(chats));
    }

    // Render list, chat, buttons
    function render() {
      // ... similar rendering logic as before ...
    }

    // Send message
    async function sendMessage() {
      const txt = document.getElementById('userInput').value.trim();
      if (!txt) return;
      const chat = chats.find(c => c.id === activeId);
      chat.messages.push({ role:'user', text: txt });
      saveChats();
      render();

      if (!genModel) {
        genModel = await pipeline('text-generation', 'Xenova/gpt2');
      }
      const out = await genModel(txt, { max_new_tokens: 80 });
      const reply = out[0].generated_text.slice(txt.length).trim();
      chat.messages.push({ role:'bot', text: reply || '...' });
      saveChats();
      render();
    }

    document.getElementById('sendBtn').onclick = sendMessage;
    document.getElementById('userInput').onkeydown = e => {
      if (e.key === 'Enter' && !e.shiftKey) sendMessage();
    };

    // Image generation using diffusers.js
    async function setupImagePipeline() {
      if (!imgPipeline) {
        imgPipeline = await DiffusionPipeline.from_pretrained('Xenova/stable-diffusion', {
          scheduler: 'karras',
        });
      }
    }

    document.getElementById('imgGenBtn').onclick = async () => {
      await setupImagePipeline();
      document.getElementById('imageModal').classList.add('visible');
    };

    document.getElementById('generateImageBtn').onclick = async () => {
      const prompt = document.getElementById('imagePrompt').value.trim();
      if (!prompt) { alert('Enter prompt'); return; }

      const w = +document.getElementById('imgWidth').value;
      const h = +document.getElementById('imgHeight').value;
      const st = +document.getElementById('imgSteps').value;
      const gs = +document.getElementById('imgGuidance').value;

      const { image } = await imgPipeline(prompt, {
        width: w, height: h,
        num_inference_steps: st,
        guidance_scale: gs,
      });

      document.getElementById('imagePreview').src = URL.createObjectURL(await image.convert('blob'));
      const chat = chats.find(c => c.id === activeId);
      chat.messages.push({ role: 'bot', text: `[Image: ${prompt}]` });
      saveChats();
      render();
    };

    document.getElementById('closeImageModalBtn').onclick = () => {
      document.getElementById('imageModal').classList.remove('visible');
    };

    // Other setup: new, delete, clear, rename, upload, voice, filtering...
    // (You can copy the complete working setup from the previous iteration.)

    // Initialize app
    async function init() {
      loadChats();
      render();
    }
    init();
  </script>
</body>
</html>
