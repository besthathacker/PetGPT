<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>PetGPT Ultimate</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #1e1e1e;
    color: white;
    margin: 0; padding: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  header, footer {
    background: #007acc;
    padding: 16px;
    text-align: center;
    font-size: 20px;
  }
  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #2b2b2b;
  }
  .message {
    margin: 6px 0;
    padding: 8px;
    border-radius: 6px;
    max-width: 75%;
    word-wrap: break-word;
  }
  .user {
    background: #3a3a3a;
    align-self: flex-end;
  }
  .bot {
    background: #007acc;
    align-self: flex-start;
  }
  #controls {
    display: flex;
    padding: 10px;
    background: #111;
    border-top: 1px solid #444;
    gap: 6px;
  }
  #userInput {
    flex: 1;
    padding: 8px;
    border: none;
    border-radius: 4px;
    background: #333;
    color: #eee;
  }
  button {
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    background: #007acc;
    color: #fff;
    cursor: pointer;
  }
  #fileUpload {
    color: #eee;
    background: #444;
    border-radius: 4px;
    padding: 8px 12px;
    cursor: pointer;
  }
  .hex-preview {
    font-family: monospace;
    font-size: 12px;
    background: #111;
    color: #0f0;
    padding: 6px;
    border-radius: 4px;
    max-width: 75%;
    overflow-x: auto;
  }
</style>
</head>
<body>

<header>🐾 PetGPT Ultimate</header>

<div id="chat"></div>

<div id="controls">
  <input id="userInput" placeholder="Type your message..." autocomplete="off" />
  <button id="sendBtn">Send</button>
  <button id="resetBtn">Reset Memory</button>
  <button id="voiceBtn">🎤 Voice Chat</button>
  <input type="file" id="fileUpload" title="Upload any file" />
</div>

<footer>© 2025 PetGPT</footer>

<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.5.0/dist/transformers.min.js"></script>
<script>
(async () => {
  // DOM refs
  const chat = document.getElementById('chat');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const resetBtn = document.getElementById('resetBtn');
  const voiceBtn = document.getElementById('voiceBtn');
  const fileUpload = document.getElementById('fileUpload');

  // Memory storage
  let memory = JSON.parse(localStorage.getItem('petgpt-memory') || '{}');

  // GPT-2 variables
  let tokenizer, model;
  let gptReady = false;

  // Simple fallback dictionary
  const fallbackModel = {
    hello: "Hi there! How can I help you today?",
    bye: "Goodbye! Have a great day!",
    "how are you": "I'm just a program, but thanks for asking!",
  };

  // Append message helper
  function append(msg, cls, isHtml = false) {
    const d = document.createElement('div');
    d.className = 'message ' + cls;
    if (isHtml) d.innerHTML = msg;
    else d.textContent = msg;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;
  }

  // Save memory
  function saveMem() {
    localStorage.setItem('petgpt-memory', JSON.stringify(memory));
  }

  // Chat reply logic
  async function getReply(text) {
    const t = text.toLowerCase();

    if (t.startsWith('remember:')) {
      const [k, v] = t.slice(9).split('=').map(s => s.trim());
      if (k && v) {
        memory[k] = v;
        saveMem();
        return `Got it! I'll remember ${k} = ${v}`;
      }
      return `Use: remember:key=value`;
    }

    for (let k in memory) {
      if (t.includes(k.toLowerCase())) return `You told me ${k} = ${memory[k]}`;
    }

    for (let key in fallbackModel) {
      if (t.includes(key)) return fallbackModel[key];
    }

    if (gptReady && model && tokenizer) {
      try {
        // Encode input
        const encoded = await tokenizer.encode(text);
        // Generate output tokens with sampling
        const output = await model.generate(encoded.inputIds, {
          max_new_tokens: 50,
          do_sample: true,
          temperature: 0.7,
          top_p: 0.9,
        });
        // Decode tokens to string
        const decoded = await tokenizer.decode(output[0]);
        // Remove input prompt from output
        let reply = decoded.replace(text, '').trim();
        if (reply.length === 0) reply = "Hmm, I don't know what to say.";
        return reply;
      } catch (e) {
        console.error("GPT-2 generation error:", e);
      }
    }

    return "Sorry, I don't understand.";
  }

  // Send message handler
  async function sendMessage() {
    const txt = userInput.value.trim();
    if (!txt) return;
    append("You: " + txt, 'user');
    userInput.value = '';
    userInput.disabled = true;
    sendBtn.disabled = true;

    try {
      const reply = await getReply(txt);
      append("PetGPT: " + reply, 'bot');
    } catch (e) {
      append("PetGPT: Sorry, an error occurred.", 'bot');
      console.error(e);
    } finally {
      userInput.disabled = false;
      sendBtn.disabled = false;
      userInput.focus();
    }
  }

  sendBtn.onclick = sendMessage;
  userInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendMessage();
    }
  });

  // Reset button
  resetBtn.onclick = () => {
    if (confirm("Clear memory and chat?")) {
      localStorage.clear();
      memory = {};
      chat.innerHTML = '';
      append("Memory cleared.", "bot");
    }
  };

  // Voice chat setup
  let recognition, recognizing = false;
  if (window.SpeechRecognition || window.webkitSpeechRecognition) {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.continuous = false;
    recognition.onstart = () => { recognizing = true; voiceBtn.textContent = '🛑 Stop'; };
    recognition.onend = () => { recognizing = false; voiceBtn.textContent = '🎤 Voice Chat'; };
    recognition.onerror = () => { recognizing = false; voiceBtn.textContent = '🎤 Voice Chat'; };
    recognition.onresult = e => {
      const t = e.results[0][0].transcript;
      userInput.value = t;
      sendMessage();
    };
  } else {
    voiceBtn.onclick = () => alert("SpeechRecognition not supported in this browser.");
  }
  voiceBtn.onclick = () => {
    if (!recognition) return alert("SpeechRecognition not supported in this browser.");
    recognizing ? recognition.stop() : recognition.start();
  };

  // File upload handling
  fileUpload.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    function toHex(buffer, maxLength = 256) {
      const bytes = new Uint8Array(buffer.slice(0, maxLength));
      return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' ');
    }

    reader.onload = event => {
      const text = event.target.result;
      const nonPrintable = text.replace(/[\x20-\x7E]/g, '').length;
      const ratio = nonPrintable / text.length;
      if (ratio > 0.3) {
        readBinary();
      } else {
        append(`<b>File loaded (text):</b> ${file.name}`, 'bot', true);
        append(text.length > 500 ? text.substring(0, 500) + "..." : text, 'bot');
        userInput.value = text.substring(0, 500);
      }
    };

    const readBinary = () => {
      const readerBin = new FileReader();
      readerBin.onload = e => {
        const hex = toHex(e.target.result);
        append(`<b>File loaded (binary):</b> ${file.name}`, 'bot', true);
        append(`<pre class="hex-preview">${hex}</pre>`, 'bot', true);
      };
      readerBin.readAsArrayBuffer(file);
    };

    reader.onerror = () => {
      append("⚠️ Cannot read file as text. Trying binary...", 'bot');
      readBinary();
    };

    reader.readAsText(file);
    fileUpload.value = "";
  };

  // Load GPT-2 model & tokenizer
  append("Loading GPT-2 AI model... Please wait.", "bot");
  try {
    tokenizer = await window.transformers.AutoTokenizer.fromPretrained("gpt2");
    model = await window.transformers.AutoModelForCausalLM.fromPretrained("gpt2");
    gptReady = true;
    append("GPT-2 AI model loaded! Test worked!", "bot");
  } catch (e) {
    append("Failed to load GPT-2 model. Falling back to simple dictionary.", "bot");
    console.error("GPT-2 load error:", e);
  }

  userInput.focus();

})();
</script>

</body>
</html>
